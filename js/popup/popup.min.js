var popup=angular.module("popupWindow",[]);popup.factory("templateCache",["$cacheFactory",function(a){return a("template-cache")}]);popup.value("windowSectors",{inner:{el:null},wrap:{el:null},header:{el:null},content:{el:null},footer:{el:null},fullscreen:{el:null}});popup.directive("popupWindow",["$popupWindow",function(a){return{link:function(d,e,b){var c=d.$watch("windowStart",function(f){if(f){var g=b.group;var h=a.unicid();e[0].setAttribute("unicid",h);if(b.group){if(f.setElements[g]){f.setElements[g].push({unicid:h,el:e})}else{f.setElements[g]=[];f.setElements[g].push({unicid:h,el:e})}}c()}})}}}]);popup.directive("windowSection",["$popupWindow","windowSectors",function(b,a){return function(e,f,c){var d=c.windowSection;switch(d){case"header":a.header={el:f};break;case"content":a.content={el:f};break;case"footer":a.footer={el:f};break;case"wrap":a.wrap={el:f};break;case"fullscreen":a.fullscreen={el:f};break}}}]);popup.directive("popupWrap",["windowSectors",function(a){return{replace:true,template:'<div id="window-wrap" ng-show="winpopup.inner.show"><div id="wrap-inner" ng-style="{width:winpopup.inner.width + \'px\', height:winpopup.inner.height + \'px\', padding:winpopup.inner.padding}"><div id="wrap-block" data-window-section="wrap" ng-style="{width:winpopup.wrap.width + \'px\', padding:winpopup.wrap.padding + \'px\'}"></div></div></div>',link:function(d,e,b){var c=d.$watch("loadWindowTemp",function(f){a.inner={el:e,loaded:true};e.on("click",function(h){var g=h.target;if(g.id==="wrap-inner"){d.$emit("window:close")}})})}}}]);popup.directive("imageIncontent",["$popupWindow","$http","$compile",function(b,c,a){return function(e,f,d){e.$emit("window:imageContent",f,d)}}]);popup.directive("htmlContent",["$popupWindow","$http","$compile",function(b,c,a){return function(e,f,d){e.$emit("window:htmlContent",f,d)}}]);popup.factory("$winStorage",["$window","$location",function(c,e){var b=function(g){var f=JSON.stringify(g.openConfig,function(h,i){if(h=="el"){return undefined}return i});localStorage.setItem(g.win_id,f)};var d=function(f){return JSON.parse(localStorage[f])};var a=function(){localStorage.clear()};return{set:b,get:d,clear:a}}]);popup.factory("$fullScreen",["$document","$rootScope",function(g,a){var f=g[0];var b=function(d){if(d.requestFullscreen){d.requestFullscreen()}else{if(d.mozRequestFullScreen){d.mozRequestFullScreen()}else{if(d.webkitRequestFullscreen){d.webkitRequestFullscreen()}else{if(d.msRequestFullscreen){d.msRequestFullscreen()}}}}};var e=function(){if(f.exitFullscreen){f.exitFullscreen()}else{if(f.mozCancelFullScreen){f.mozCancelFullScreen()}else{if(f.webkitCancelFullScreen){f.webkitCancelFullScreen()}else{if(f.msExitFullscreen){f.msExitFullscreen()}}}}};var c=function(){if(f.fullscreenEnabled){f.addEventListener("fullscreenchange",function(){if(!f.fullScreen){}},false)}else{if(f.mozFullScreenEnabled){f.addEventListener("mozfullscreenchange",function(){if(!f.mozFullScreen){}},false)}else{if(f.webkitFullscreenEnabled){f.addEventListener("webkitfullscreenchange",function(){if(!f.webkitIsFullScreen){a.$emit("window:fullScreenClose")}},false)}else{if(f.msFullscreenEnabled){f.addEventListener("msfullscreenchange",function(){if(!f.msFullscreenElement){}},false)}}}}};return{openFullScreen:b,cancelFullScreen:e,fullScreeEvent:c}}]);popup.factory("$popupWindow",["$rootScope","$window","$document","$interval","$http","$compile","windowSectors","$timeout","$location","$winStorage","$rootElement","templateCache","$fullScreen",function(o,r,y,u,z,v,s,w,m,e,g,i,d){var f,c,a,p,q,x,n=angular.element(r),b,t;var l=function(C){if(!(this instanceof l)){return new l(C)}c=C.scope;angular.extend(this,{config:{},root:o,scope:C.scope,setElements:{},queue:[],timestamp:Date.now(),el:null,group:null,index:null,unicid:null,currContent:null,loadImages:{},pushState:true,tpls:[],body:y[0].querySelector("body")});q={resize:true,padding:15,margin:10,outPadding:100,winType:"image",innerTpl:"tpl/defaultWrapTpl.html",maxSizes:{width:1024,height:768},minSizes:{width:640,height:480},ajax:{method:"post",url:"test.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8"},data:{}},dataRequest:{},userControl:false,effect:1};f=this;a=null;p={};x=null;b=null;angular.extend(this.config,q,C);x=this.config;t=0;c.$on("window:navigate",this._windowPagination.bind(this));c.$on("window:imageLoaded",this._windowImageLoaded.bind(this));c.$on("window:contentLoaded",this._windowContentLoaded.bind(this));this.root.$on("window:fullScreenClose",function(){this.cancelFullScreen()}.bind(this));if(this.pushState){var B=m.search();if(B.win_id){var A=e.get(B.win_id);if(A){w(function(){var D=g[0].querySelector("#"+B.win_id);if(D){A.el=angular.element(D);this.open(A)}}.bind(this),0)}}}c.$on("window:close",function(){this.closeWindow()}.bind(this));d.fullScreeEvent();c.$watch("winpopup.slideshow",function(D){if(D!==undefined){if(D){u.cancel(t);t=u(function(){this.getNext()}.bind(this),5000)}else{u.cancel(t)}}}.bind(this));c.windowStart=this;c.loadWindowTemp=this};l.prototype={open:function(B){var A={};angular.extend(A,q,B);angular.extend(this,{el:B.el,group:B.el[0].getAttribute("data-group"),unicid:B.el[0].getAttribute("unicid"),config:A,win_id:B.el[0].id});x=this.config;if(this.group){this._getIndexFromNabor()}this._loadInnerTpl(function(){w(function(){this._defaultWindow();this._loadContent()}.bind(this),0)}.bind(this));n.on("resize",function(){this.currWrapWidth=null;this._windowResize()}.bind(this))},_loadInnerTpl:function(C){if(x.innerTpl){var A=i.get(x.innerTpl);if(!A){z.post(x.innerTpl).success(function(E){s.wrap.el.html(E);var D=s.wrap.el.contents();v(D)(this.scope);i.put(x.innerTpl,E);C()}.bind(this))}else{s.wrap.el.html(A);var B=s.wrap.el.contents();v(B)(this.scope);C()}}else{throw ("Не указан шаблон внутренней части окна!")}},_getIndexFromNabor:function(){angular.forEach(this.setElements[this.group],function(B,A){if(B.unicid===this.unicid){this.index=A}}.bind(this))},_defaultWindow:function(){var B=this.setElements[this.group];a=this.sizes=this.getTrueWindowSize();var A={counter:B?B.length:0,index:this.index+1,inner:{padding:x.margin+"px 0 "+x.margin+"px 0",width:a.pageWidth,height:a.viewHeight},wrap:{padding:x.padding,width:this.getWrapWidth()},navigation:{preloader:false,prev:false,next:false},content:{}};c.winpopup=A;switch(x.effect){case 1:s.wrap.el.addClass("win-effect-1");break;case 2:s.wrap.el.addClass("win-effect-2");break;case 3:s.wrap.el.addClass("win-effect-3");break;case 4:s.wrap.el.addClass("win-effect-4");break;case 5:s.wrap.el.addClass("win-effect-5");break}},_windowPagination:function(C,B,A,D){switch(A){case"next":this.index=this.index+1;break;case"prev":this.index=this.index-1;break}angular.extend(this,{el:B,unicid:B[0].getAttribute("unicid"),win_id:B[0].id});this.currWrapWidth=this.getWrapWidth();if(!c.winpopup.fullscreen){s.wrap.el.removeClass("win-show").addClass("win-close")}else{s.fullscreen.el.removeClass("win-show").addClass("win-close")}this._trigger("window:beforePagination",B,s);w(function(){this._loadContent();c.winpopup.index=this.index+1}.bind(this),600)},_loadContent:function(){this._trigger("window:beforeContentLoaded",s);p=x.dataRequest||{};switch(x.winType){case"image":new k(this.el);break;case"ajax":x.ajax.data=x.dataRequest;x.ajax.transformRequest=function(A){return this.toParam(A)}.bind(this);z(x.ajax).success(function(C,A){b=C;if(C instanceof Object){if(C.src){new h(this.el,"image",C)}else{new h(this.el,"json",C)}}else{s.content.el.html(C);var B=s.content.el.contents();v(B)(c)}}.bind(this)).error(function(B,A){throw ("При попытке получения данных произошел сбой!")});c.$on("window:imageContent",function(C,B,A){new k(B)}.bind(this));c.$on("window:htmlContent",function(C,B,A){new h(B,"html")});break}},_windowImageLoaded:function(B,A){this.currContent=A;c.winpopup.content=A;if(x.resize){if(A.ratio<1){if(A.width<=x.minSizes.width){c.winpopup.wrap.width=x.minSizes.width}else{c.winpopup.wrap.width=A.width}}else{c.winpopup.wrap.width=A.width}}else{c.winpopup.wrap.width=x.maxSizes.width}this.afterLoad(A)},_windowContentLoaded:function(B,A){this.currContent=A;c.winpopup.content=A;this.afterLoad(A)},afterLoad:function(A){var B;if(this.group){if(this.index===0){if(this.setElements[this.group].length===1){B={next:false,prev:false}}else{B={next:true,prev:false}}}else{if(this.index===(this.setElements[this.group].length-1)){B={next:false,prev:true}}else{B={next:true,prev:true}}}c.winpopup.navigation=B}if(x.userControl){this._trigger("window:userControll",A,s,b)}else{c.winpopup.inner.show=true;this._updateUrl()}this._windowResize();this.updateScope();w(function(){if(!c.winpopup.fullscreen){s.wrap.el.removeClass("win-close").addClass("win-show")}else{s.fullscreen.el.removeClass("win-close").addClass("win-show")}},50);this.body.style.overflow="hidden";this._trigger("window:afterContentLoaded",this.currContent,s,b)},bind:function(C,B){var A=C+":"+this.timestamp;c.$on(A,B.bind(this))},_trigger:function(A){arguments[0]=A+":"+this.timestamp;c.$broadcast.apply(c,arguments)},getWrapWidth:function(){var A=a.pageWidth-x.outPadding*2;if(A<x.minSizes.width){A=x.minSizes.width}else{if(A>x.maxSizes.width){A=x.maxSizes.width}}return A},_windowResize:function(){a=this.getTrueWindowSize();var D=a.pageWidth,C=a.viewHeight,B=null,A=null;c.winpopup.inner.width=D;c.winpopup.inner.height=C;if(x.resize){A=this.getWrapWidth();c.winpopup.wrap.width=A;if(!this.currContent.param.noResize){if(c.winpopup.fullscreen){B=this.getNewSize(this.currContent,1)}else{B=this.getNewSize(this.currContent)}if(this.currContent.ratio<1){if(B[0]<=x.minSizes.width){c.winpopup.wrap.width=x.minSizes.width}else{c.winpopup.wrap.width=B[0]}}else{c.winpopup.wrap.width=B[0]}c.winpopup.content.width=c.winpopup.content.el.width=B[0];c.winpopup.content.height=c.winpopup.content.el.height=B[1]}}this.updateScope()},_updateUrl:function(){if(this.pushState&&this.currContent.win_id){var A=m.search();A.win_id=this.currContent.win_id;m.search(A);e.set(this.currContent)}},updateScope:function(){this.root.$$phase||this.root.$digest()},getTrueWindowSize:function(){var F,A,C,E,D,H,G=y[0],B=r;F=G.body.scrollWidth;A=G.body.scrollHeight;D=B.innerWidth;H=B.innerHeight;if(A<H){E=H}else{E=A}if(F<D){C=D}else{C=F}return{pageWidth:C,pageHeight:E,viewWidth:D,viewHeight:H,pageWidthScroll:F,pageHeightScroll:A}},getNewSize:function(G,D){var F=this.currWrapWidth||c.winpopup.wrap.width,B=a.viewHeight,A={};if(D){F=a.pageWidth}var C=F,E=B-(x.margin*2+x.padding*2);if(G.ratio<1){E-=x.outPadding}if(E<x.minSizes.height){E=x.minSizes.height}if((G.oric_width/C)>(G.oric_height/E)){A[0]=C;A[1]=Math.round(G.oric_height*C/G.oric_width)}else{A[0]=Math.round(G.oric_width*E/G.oric_height);A[1]=E}return A},toParam:function(B){if(B){var A="";angular.forEach(B,function(D,C){A+=C+"="+D+"&"});A=A.substr(0,A.length-1);return A}},closeWindow:function(){n.off("resize");p={};c.winpopup.inner.show=false;this.currWrapWidth=null;this._defaultWindow();s.wrap.el.removeClass("win-show").addClass("win-close");this.updateScope();this.body.style.overflow="auto";if(this.pushState){var A=m.search();delete A.win_id;m.search(A)}},getNext:function(B){if(angular.isFunction(B)){B(s)}else{var A=this.setElements[this.group][this.index+1];if(!A){this.index=-1;A=this.setElements[this.group][0]}c.$emit("window:navigate",A.el,"next",B||{})}},getPrev:function(B){if(angular.isFunction(B)){B(s)}else{var A=this.setElements[this.group][this.index-1];c.$emit("window:navigate",A.el,"prev",B||{})}},fullScreen:function(){if(s.fullscreen&&this.currContent.el.tagName==="IMG"){var A=this.getNewSize(this.currContent,1);s.fullscreen.el.addClass("win-effect-1 win-show");x.maxSizes={width:A[0],height:A[1]};c.winpopup.fullscreen=true;d.openFullScreen(s.fullscreen.el[0])}},cancelFullScreen:function(){var A=this.currContent;s.fullscreen.el.removeClass("win-effect-1 win-show");x.maxSizes=A.openConfig.maxSizes;c.winpopup.fullscreen=false;d.cancelFullScreen()},data:{}};var k=function(C){angular.extend(this,{unicid:C[0].getAttribute("unicid")||j(),win_id:C[0].id});if(c.winpopup.fullscreen){this.openConfig=angular.extend({},f.currContent.openConfig)}else{this.openConfig=angular.extend({},x)}var A=C[0].tagName,B;switch(A){case"A":B=C[0].href;break;case"IMG":B=C[0].src;break}if(B){this.createImageObject(B)}else{throw ("Вы не передали ссылку на картинку!")}};k.prototype.createImageObject=function(B){var C,A;A=new Image();A.onload=function(){angular.extend(this,{oric_height:A.height,oric_width:A.width,src:B,el:A,param:p});this.ratio=this.oric_width/this.oric_height;C=f.getNewSize(this);this.width=this.el.width=C[0];this.height=this.el.height=C[1];c.$broadcast("window:imageLoaded",this);A=null}.bind(this);A.onerror=function(){throw ("Такого изображения не существует!")};A.src=B};var h=function(D,B,A){angular.extend(this,{unicid:D[0].getAttribute("unicid")||j(),win_id:D[0].id,param:{}});if(c.winpopup.fullscreen){this.openConfig=angular.extend({},f.currContent.openConfig)}else{this.openConfig=angular.extend({},x)}switch(B){case"image":var C=A.src;angular.extend(this.param,p,A);this.getImage(C,function(E){c.$broadcast("window:imageLoaded",this)}.bind(this));break;case"json":this.param.noResize=true;angular.extend(this.param,p,A);c.$broadcast("window:contentLoaded",this);break;case"html":this.param.noResize=true;angular.extend(this.param,p);c.$broadcast("window:contentLoaded",this);break}};h.prototype.getImage=function(B,D){var A=new Image(),C;A.onload=function(){angular.extend(this,{oric_height:A.height,oric_width:A.width,src:B,el:A});this.ratio=this.oric_width/this.oric_height;C=f.getNewSize(this);this.width=this.el.width=C[0];this.height=this.el.height=C[1];D(this);A=null}.bind(this);A.onerror=function(){throw ("Картинки с таким адресом не существует!")};A.src=B};var j=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)};return{init:function(A){return l(A)},unicid:j}}]);