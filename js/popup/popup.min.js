var popup=angular.module("popupWindow",[]);popup.factory("templateCache",["$cacheFactory",function(a){return a("template-cache")}]);popup.value("windowSectors",{inner:{el:null},wrap:{el:null},header:{el:null},content:{el:null},footer:{el:null},fullscreen:{el:null}});popup.directive("popupWindow",["$popupWindow",function(a){return{link:function(d,e,b){var c=d.$watch("windowStart",function(f){if(f){var g=b.group;var h=a.unicid();e[0].setAttribute("unicid",h);if(b.group){if(f.setElements[g]){f.setElements[g].push({unicid:h,el:e})}else{f.setElements[g]=[];f.setElements[g].push({unicid:h,el:e})}}c()}})}}}]);popup.directive("windowSection",["$popupWindow","windowSectors","$compile","$http",function(c,a,b,d){return function(g,h,e){var f=e.windowSection;switch(f){case"header":a.header={el:h};break;case"content":a.content={el:h};break;case"footer":a.footer={el:h};break;case"wrap":a.wrap={el:h};break;case"fullscreen":a.fullscreen={el:h};break}}}]);popup.directive("popupWrap",["windowSectors",function(a){return{replace:true,template:'<div id="window-wrap" ng-show="winpopup.inner.show"><div id="wrap-inner" ng-style="{width:winpopup.inner.width + \'px\', height:winpopup.inner.height + \'px\', padding:winpopup.inner.padding}"><div id="wrap-block" ng-hide="winpopup.fullscreen" data-window-section="wrap" ng-style="{width:winpopup.wrap.width + \'px\', padding:winpopup.wrap.padding + \'px\'}"></div></div><div id="fullScreen" ng-show="winpopup.fullscreen" data-window-section="fullscreen"></div></div>',link:function(d,e,b){var c=d.$watch("loadWindowTemp",function(f){a.inner={el:e,loaded:true};e.on("click",function(h){var g=h.target;if(g.id==="wrap-inner"){d.$emit("window:close")}})})}}}]);popup.directive("imageIncontent",["$popupWindow","$http","$compile",function(b,c,a){return function(e,f,d){e.$emit("window:imageContent",f,d)}}]);popup.directive("htmlContent",["$popupWindow","$http","$compile",function(b,c,a){return function(e,f,d){e.$emit("window:htmlContent",f,d)}}]);popup.factory("$winStorage",["$window","$location",function(c,e){var b=function(g){var f=JSON.stringify(g.openConfig,function(h,i){switch(h){case"el":return undefined;break;case"beforeContentLoaded":case"beforePagination":case"afterContentLoaded":return i.toString();break}return i});localStorage.setItem(g.win_id,f)};var d=function(f){return JSON.parse(localStorage[f])};var a=function(){localStorage.clear()};return{set:b,get:d,clear:a}}]);popup.factory("$fullScreen",["$document","$rootScope",function(g,a){var f=g[0];var b=function(d){if(d.requestFullscreen){d.requestFullscreen()}else{if(d.mozRequestFullScreen){d.mozRequestFullScreen()}else{if(d.webkitRequestFullscreen){d.webkitRequestFullscreen()}else{if(d.msRequestFullscreen){d.msRequestFullscreen()}}}}};var e=function(){if(f.exitFullscreen){f.exitFullscreen()}else{if(f.mozCancelFullScreen){f.mozCancelFullScreen()}else{if(f.webkitCancelFullScreen){f.webkitCancelFullScreen()}else{if(f.msExitFullscreen){f.msExitFullscreen()}}}}};var c=function(){if(f.fullscreenEnabled){f.addEventListener("fullscreenchange",function(){if(!f.fullScreen){a.$emit("window:fullScreenClose")}},false)}else{if(f.mozFullScreenEnabled){f.addEventListener("mozfullscreenchange",function(){if(!f.mozFullScreen){a.$emit("window:fullScreenClose")}},false)}else{if(f.webkitFullscreenEnabled){f.addEventListener("webkitfullscreenchange",function(){if(!f.webkitIsFullScreen){a.$emit("window:fullScreenClose")}},false)}else{if(f.msFullscreenEnabled){f.addEventListener("msfullscreenchange",function(){if(!f.msFullscreenElement){a.$emit("window:fullScreenClose")}},false)}}}}};return{openFullScreen:b,cancelFullScreen:e,fullScreeEvent:c}}]);popup.factory("$popupWindow",["$rootScope","$window","$document","$interval","$http","$compile","windowSectors","$timeout","$location","$winStorage","$rootElement","templateCache","$fullScreen",function(o,s,z,v,A,w,t,x,m,e,g,i,d){var f,c,a,q,r,y,n=angular.element(s),b,u,p;var l=function(D){if(!(this instanceof l)){return new l(D)}c=D.scope;angular.extend(this,{config:{},root:o,scope:D.scope,setElements:{},queue:[],timestamp:Date.now(),el:null,group:null,index:null,unicid:null,currContent:null,loadImages:{},pushState:true,tpls:[],body:z[0].querySelector("body")});r={resize:true,padding:15,margin:10,outPadding:100,winType:"image",innerTpl:"tpl/defaultWrapTpl.html",fullScreenTpl:"tpl/fullScreenTpl.html",maxSizes:{width:1024,height:768},minSizes:{width:640,height:480},ajax:{method:"post",url:"test.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8"},data:{}},dataRequest:{},userControl:false,effect:1};f=this;a=null;q={};y=null;b=null;angular.extend(this.config,r,D);y=this.config;u=0;c.$on("window:navigate",this._windowPagination.bind(this));c.$on("window:imageLoaded",this._windowImageLoaded.bind(this));c.$on("window:contentLoaded",this._windowContentLoaded.bind(this));if(this.pushState){var C=m.search();if(C.win_id){var B=e.get(C.win_id);if(B){x(function(){var E=g[0].querySelector("#"+C.win_id);if(E){B.el=angular.element(E);this.open(B)}}.bind(this),1000)}}}c.$on("window:close",function(){this.closeWindow()}.bind(this));d.fullScreeEvent();c.$watch("winpopup.slideshow",function(E){if(E!==undefined){if(E){v.cancel(u);u=v(function(){this.getNext()}.bind(this),5000)}else{v.cancel(u)}}}.bind(this));c.windowStart=this;c.loadWindowTemp=this};l.prototype={open:function(C){var B={innerTplMark:C.innerTpl?C.innerTpl.replace(/[\/,\.]/g,"__"):r.innerTpl.replace(/[\/,\.]/g,"__"),fullScreenTplMark:C.fullScreenTpl?C.fullScreenTpl.replace(/[\/,\.]/g,"__"):r.fullScreenTpl.replace(/[\/,\.]/g,"__")};angular.extend(B,r,C);angular.extend(this,{el:C.el,group:C.el[0].getAttribute("data-group"),unicid:C.el[0].getAttribute("unicid"),config:B,win_id:C.el[0].id});y=this.config;if(this.group){this._getIndexFromNabor()}this._loadInnerTpl(function(){x(function(){this._defaultWindow();this._loadContent()}.bind(this),0)}.bind(this));n.on("resize",function(){this.currWrapWidth=null;this._windowResize()}.bind(this))},_loadInnerTpl:function(E){if(y.innerTpl){var B=i.get(y.innerTpl),D=t.wrap.el[0].querySelector("[mark="+y.innerTplMark+"]");if(!B&&!D){A.post(y.innerTpl).success(function(G){t.wrap.el.html(G);var F=t.wrap.el.contents();F.attr("mark",y.innerTplMark);w(F)(this.scope);i.put(y.innerTpl,G);E()}.bind(this))}else{if(B&&!D){t.wrap.el.html(B);var C=t.wrap.el.contents();w(C)(this.scope);E()}else{E()}}}else{throw ("Не указан шаблон внутренней части окна!")}},_getIndexFromNabor:function(){angular.forEach(this.setElements[this.group],function(C,B){if(C.unicid===this.unicid){this.index=B}}.bind(this))},_defaultWindow:function(){var C=this.setElements[this.group];a=this.sizes=this.getTrueWindowSize();var B={counter:C?C.length:0,index:this.index+1,inner:{padding:y.margin+"px 0 "+y.margin+"px 0",width:a.pageWidth,height:a.viewHeight},wrap:{padding:y.padding,width:this.getWrapWidth()},navigation:{preloader:false,prev:false,next:false},content:{}};c.winpopup=B;switch(y.effect){case 1:t.wrap.el.addClass("win-effect-1");break;case 2:t.wrap.el.addClass("win-effect-2");break;case 3:t.wrap.el.addClass("win-effect-3");break;case 4:t.wrap.el.addClass("win-effect-4");break;case 5:t.wrap.el.addClass("win-effect-5");break}},_windowPagination:function(D,C,B,E){switch(B){case"next":this.index=this.index+1;break;case"prev":this.index=this.index-1;break}angular.extend(this,{el:C,unicid:C[0].getAttribute("unicid"),win_id:C[0].id});this.currWrapWidth=this.getWrapWidth();if(!c.winpopup.fullscreen){t.wrap.el.removeClass("win-show").addClass("win-close")}else{t.fullscreen.el.removeClass("win-show").addClass("win-close")}this._callEvent("beforePagination",C,t);x(function(){this._loadContent();c.winpopup.index=this.index+1}.bind(this),600)},_loadContent:function(){this._callEvent("beforeContentLoaded",y,t);q=y.dataRequest||{};switch(y.winType){case"image":new k(this.el);break;case"ajax":if(y.ajax.method==="get"){y.ajax.params=y.dataRequest}else{y.ajax.transformRequest=function(B){return this.toParam(B)}.bind(this)}angular.extend(r.ajax,y.ajax);A(y.ajax).success(function(D,B){b=D;if(D instanceof Object){if(D.src){new h(this.el,"image",D)}else{new h(this.el,"json",D)}}else{t.content.el.html(D);var C=t.content.el.contents();w(C)(c)}}.bind(this)).error(function(C,B){throw ("При попытке получения данных произошел сбой!")});c.$on("window:imageContent",function(D,C,B){new k(C)}.bind(this));c.$on("window:htmlContent",function(D,C,B){new h(C,"html")});break;case"inline":break}},_callEvent:function(D,E,C,B){this._trigger("window:"+D,E,C,B);if(y[D]){if(typeof y[D]==="string"){new Function("first","second","third","call = "+y[D]+"; return call(first, second);")(E,C,B)}else{y[D](E,C,B)}}},_windowImageLoaded:function(C,B){this.currContent=B;c.winpopup.content=B;if(y.resize){if(B.ratio<1){if(B.width<=y.minSizes.width){c.winpopup.wrap.width=y.minSizes.width}else{c.winpopup.wrap.width=B.width}}else{c.winpopup.wrap.width=B.width}}else{c.winpopup.wrap.width=y.maxSizes.width}this.afterLoad(B)},_windowContentLoaded:function(C,B){this.currContent=B;c.winpopup.content=B;this.afterLoad(B)},afterLoad:function(B){var C;if(this.group){if(this.index===0){if(this.setElements[this.group].length===1){C={next:false,prev:false}}else{C={next:true,prev:false}}}else{if(this.index===(this.setElements[this.group].length-1)){C={next:false,prev:true}}else{C={next:true,prev:true}}}c.winpopup.navigation=C}if(y.userControl){this._trigger("window:userControll",B,t,b)}else{c.winpopup.inner.show=true;this._updateUrl()}this._windowResize();this.updateScope();x(function(){if(!c.winpopup.fullscreen){t.wrap.el.removeClass("win-close").addClass("win-show")}else{t.fullscreen.el.removeClass("win-close").addClass("win-show")}},100);this.body.style.overflow="hidden";this._callEvent("afterContentLoaded",this.currContent,t,b)},bind:function(D,C){var B=D+":"+this.timestamp;c.$on(B,C.bind(this))},_trigger:function(B){arguments[0]=B+":"+this.timestamp;c.$broadcast.apply(c,arguments)},getWrapWidth:function(){var B=a.pageWidth-y.outPadding*2;if(B<y.minSizes.width){B=y.minSizes.width}else{if(B>y.maxSizes.width){B=y.maxSizes.width}}return B},_windowResize:function(){a=this.getTrueWindowSize();var E=a.pageWidth,D=a.viewHeight,C=null,B=null;c.winpopup.inner.width=E;c.winpopup.inner.height=D;if(y.resize){B=this.getWrapWidth();c.winpopup.wrap.width=B;if(!this.currContent.param.noResize){if(c.winpopup.fullscreen){C=this.getNewSize(this.currContent,1)}else{C=this.getNewSize(this.currContent)}if(this.currContent.ratio<1){if(C[0]<=y.minSizes.width){c.winpopup.wrap.width=y.minSizes.width}else{c.winpopup.wrap.width=C[0]}}else{c.winpopup.wrap.width=C[0]}c.winpopup.content.width=c.winpopup.content.el.width=C[0];c.winpopup.content.height=c.winpopup.content.el.height=C[1]}}this.updateScope()},_updateUrl:function(){if(this.pushState&&this.currContent.win_id){var B=m.search();B.win_id=this.currContent.win_id;m.search(B);e.set(this.currContent)}},updateScope:function(){this.root.$$phase||this.root.$digest()},getTrueWindowSize:function(){var G,B,D,F,E,I,H=z[0],C=s;G=H.body.scrollWidth;B=H.body.scrollHeight;E=C.innerWidth;I=C.innerHeight;if(B<I){F=I}else{F=B}if(G<E){D=E}else{D=G}return{pageWidth:D,pageHeight:F,viewWidth:E,viewHeight:I,pageWidthScroll:G,pageHeightScroll:B}},getNewSize:function(H,E){var G=this.currWrapWidth||c.winpopup.wrap.width,C=a.viewHeight,B={};if(E){G=a.pageWidth}var D=G,F=C-(y.margin*2+y.padding*2);if(H.ratio<1){F-=y.outPadding}if(F<y.minSizes.height){F=y.minSizes.height}if((H.oric_width/D)>(H.oric_height/F)){B[0]=D;B[1]=Math.round(H.oric_height*D/H.oric_width)}else{B[0]=Math.round(H.oric_width*F/H.oric_height);B[1]=F}return B},toParam:function(C){if(C){var B="";angular.forEach(C,function(E,D){B+=D+"="+E+"&"});B=B.substr(0,B.length-1);return B}},closeWindow:function(){n.off("resize");q={};c.winpopup.inner.show=false;this.currWrapWidth=null;this._defaultWindow();t.wrap.el.removeClass("win-show").addClass("win-close");this.updateScope();this.body.style.overflow="auto";if(this.pushState){var B=m.search();delete B.win_id;m.search(B)}},getNext:function(C){if(angular.isFunction(C)){C(t)}else{var B=this.setElements[this.group][this.index+1];if(!B){this.index=-1;B=this.setElements[this.group][0]}c.$emit("window:navigate",B.el,"next",C||{})}},getPrev:function(C){if(angular.isFunction(C)){C(t)}else{var B=this.setElements[this.group][this.index-1];c.$emit("window:navigate",B.el,"prev",C||{})}},fullScreen:function(){p=this.root.$on("window:fullScreenClose",function(){this.cancelFullScreen()}.bind(this));z.on("keydown",function(F){if(F.keyCode===116){F.preventDefault()}});var E=t.fullscreen.el[0].querySelector("[mark="+y.fullScreenTplMark+"]"),B=i.get(y.fullScreenTpl);if(!E&&!B){A.post(y.fullScreenTpl).success(function(G){t.fullscreen.el.html(G);var F=t.fullscreen.el.contents();F[0].setAttribute("mark",y.fullScreenTplMark);w(F)(c);i.put(y.fullScreenTpl,G)})}else{if(!E&&B){t.fullscreen.el.html(B);var C=t.fullscreen.el.contents();w(C)(c)}}if(t.fullscreen&&this.currContent.el.tagName==="IMG"){var D=this.getNewSize(this.currContent,1);t.fullscreen.el.addClass("win-effect-1 win-show");y.maxSizes={width:D[0],height:D[1]};c.winpopup.fullscreen=true;d.openFullScreen(t.fullscreen.el[0])}},cancelFullScreen:function(){p();z.off("keydown");var B=this.currContent;t.fullscreen.el.removeClass("win-effect-1 win-show");y.maxSizes=B.openConfig.maxSizes;c.winpopup.fullscreen=false;d.cancelFullScreen();this._windowResize()},data:{}};var k=function(D){angular.extend(this,{unicid:D[0].getAttribute("unicid")||j(),win_id:D[0].id});if(c.winpopup.fullscreen){this.openConfig=angular.extend({},f.currContent.openConfig)}else{this.openConfig=angular.extend({},y)}var B=D[0].tagName,C;switch(B){case"A":C=D[0].href;break;case"IMG":C=D[0].src;break}if(C){this.createImageObject(C)}else{throw ("Вы не передали ссылку на картинку!")}};k.prototype.createImageObject=function(C){var D,B;B=new Image();B.onload=function(){angular.extend(this,{oric_height:B.height,oric_width:B.width,src:C,el:B,param:q});this.ratio=this.oric_width/this.oric_height;D=f.getNewSize(this);this.width=this.el.width=D[0];this.height=this.el.height=D[1];c.$broadcast("window:imageLoaded",this);B=null}.bind(this);B.onerror=function(){throw ("Такого изображения не существует!")};B.src=C};var h=function(E,C,B){angular.extend(this,{unicid:E[0].getAttribute("unicid")||j(),win_id:E[0].id,param:{}});if(c.winpopup.fullscreen){this.openConfig=angular.extend({},f.currContent.openConfig)}else{this.openConfig=angular.extend({},y)}switch(C){case"image":var D=B.src;angular.extend(this.param,q,B);this.getImage(D,function(F){c.$broadcast("window:imageLoaded",this)}.bind(this));break;case"json":this.param.noResize=true;angular.extend(this.param,q,B);c.$broadcast("window:contentLoaded",this);break;case"html":this.param.noResize=true;angular.extend(this.param,q);c.$broadcast("window:contentLoaded",this);break}};h.prototype.getImage=function(C,E){var B=new Image(),D;B.onload=function(){angular.extend(this,{oric_height:B.height,oric_width:B.width,src:C,el:B});this.ratio=this.oric_width/this.oric_height;D=f.getNewSize(this);this.width=this.el.width=D[0];this.height=this.el.height=D[1];E(this);B=null}.bind(this);B.onerror=function(){throw ("Картинки с таким адресом не существует!")};B.src=C};var j=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)};return{init:function(B){return l(B)},unicid:j}}]);