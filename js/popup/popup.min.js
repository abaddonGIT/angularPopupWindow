var win=angular.module("popupWindow",[]);win.factory("$tplCache",["$cacheFactory",function(a){return a("tplCache")}]);win.value("$sectors",{});win.value("$groups",{});win.directive("ngSectors",["$sectors",function(a){return function(c,d,b){a[b.ngSectors]=d}}]);win.directive("ngGroup",["$groups","$popupWindow",function(a,b){return function(e,f,c){var g=c.ngGroup,d=b.unicid();f[0].setAttribute("unicid",d);if(a[g]){a[g].push({unicid:d,target:f})}else{a[g]=[];a[g].push({unicid:d,target:f})}}}]);win.directive("ngPopupWin",["$popupWindow","$rootScope","$interval",function(c,a,b){return{scope:{options:"=?",win:"=?",ngClick:"="},replace:false,template:'<div id="window-wrap" ng-show="show"></div><div ng-show="show" id="wrap-inner" ng-style="{width:inner.width + \'px\', height:inner.height + \'px\', padding:inner.padding}"><div id="wrap-block" ng-sectors="wrap" ng-hide="fullscreen" ng-style="{width: content.width + \'px\', padding: content.padding + \'px\'}"></div></div><div ng-sectors="fullScreen" ng-show="fullscreen"></div>',link:function(e,f,d){e.$watch("options",function(h){if(h!==undefined){if(e.options){e.options.sc=e}else{e.options={sc:e}}var i=c.create(e.options);e.close=function(){i.close()};e.prev=function(){i.prev()};e.next=function(){i.next()};e.full=function(){i.full()};e.unfull=function(){i.unfull()};var g;e.$watch("slideshow",function(j){if(j!==undefined){if(j){b.cancel(g);g=b(function(){i.next()},5000)}else{b.cancel(g)}}})}})}}}]);win.factory("$storage",[function(){var b=function(e){var d=JSON.stringify(e,function(f,g){switch(f){case"target":case"scope":return undefined;break;case"beforeContentLoaded":case"beforePagination":case"afterContentLoaded":case"afterClose":case"winResize":return g.toString();break}return g});localStorage.setItem(e.win_id,d)};var c=function(d){return JSON.parse(localStorage[d])};var a=function(){localStorage.clear()};return{set:b,get:c,clear:a}}]);win.factory("$fullScreen",["$document","$rootScope",function(g,a){var f=g[0];var b=function(d){if(d.requestFullscreen){d.requestFullscreen()}else{if(d.mozRequestFullScreen){d.mozRequestFullScreen()}else{if(d.webkitRequestFullscreen){d.webkitRequestFullscreen()}else{if(d.msRequestFullscreen){d.msRequestFullscreen()}}}}};var e=function(){if(f.exitFullscreen){f.exitFullscreen()}else{if(f.mozCancelFullScreen){f.mozCancelFullScreen()}else{if(f.webkitCancelFullScreen){f.webkitCancelFullScreen()}else{if(f.msExitFullscreen){f.msExitFullscreen()}}}}};var c=function(){if(f.fullscreenEnabled){f.addEventListener("fullscreenchange",function(){if(!f.fullScreen){a.$emit("window:fullScreenClose")}},false)}else{if(f.mozFullScreenEnabled){f.addEventListener("mozfullscreenchange",function(){if(!f.mozFullScreen){a.$emit("window:fullScreenClose")}},false)}else{if(f.webkitFullscreenEnabled){f.addEventListener("webkitfullscreenchange",function(){if(!f.webkitIsFullScreen){a.$emit("window:fullScreenClose")}},false)}else{if(f.msFullscreenEnabled){f.addEventListener("msfullscreenchange",function(){if(!f.msFullscreenElement){a.$emit("window:fullScreenClose")}},false)}}}}};return{openFullScreen:b,cancelFullScreen:e,fullScreeEvent:c}}]);win.factory("$popupWindow",["$rootScope","$timeout","$interval","$tplCache","$sectors","$document","$window","$http","$compile","$storage","$location","$groups","$fullScreen",function(i,r,o,b,l,s,m,u,p,h,g,a,d){var t,q,c,k,j={pushState:false,target:null,resize:true,margin:10,effect:1,source:null,scope:null,type:"image",href:null,imageClass:"resize",keyControll:true,win_id:null,innerTpl:"tpl/defInnerTpl.html",fullScreenTpl:"tpl/fullScreenTpl.html",outPadding:100,padding:10,resizeDelay:100,requestParam:{},ajax:{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8"}},maxSizes:{width:1024,height:768},minSizes:{width:640,height:480}};d.fullScreeEvent();var n=function(x){if(!(this instanceof n)){return new n(x)}v=this.config={locScope:null,root:i,windows:[],currWindow:null,timestamp:Date.now(),timerDelay:0};angular.extend(v,x);c=this.config.sc;this.open=function(z){var A=new f(z);this._loadTpl.call(A,"innerTpl",function(){this._getContent(A)}.bind(this))};var w=g.search();angular.element(m).on("resize",function(){if(this.currWindow){this.delay(function(){this._resizeWindow()}.bind(this))}}.bind(this));v.locScope.win=this;q=this;if(w.win_id){var v=h.get(w.win_id);var y=function(){r(function(){v.target=s[0].querySelector("#"+w.win_id);if(v.target){this.open(v)}else{y.call(this)}}.bind(this),100)};y.call(this)}c.$on("content:ready",function(B,z,A){A.content=z;this.currWindow=A;if(angular.isObject(z)){c.param={};angular.extend(c.param,A.requestParam,z)}else{c.param=A.requestParam}c.show=true;r(function(){if(c.fullscreen){l.fullScreen.removeClass("win-close").addClass("win-show")}else{l.wrap.removeClass("win-close").addClass("win-show")}angular.element(s[0].body).css("overflow","hidden");if(A.group){var C=a[A.group].length;c.count=C;c.index=A.index+1;if(C===1){c.nav={prev:false,next:false}}else{if(A.index===0){c.nav={prev:false,next:true}}else{if(A.index===C-1){c.nav={prev:true,next:false}}else{c.nav={prev:true,next:true}}}}}else{c.nav={prev:false,next:false}}this.callEvent("afterContentLoaded",A,l)}.bind(this),100);this._updateUrl(A);this.updateScope()}.bind(this));this.close=function(){c.show=false;if(w.win_id){delete w.win_id;g.search(w)}angular.element(s[0].body).css("overflow","auto");l.wrap.removeClass("win-show").addClass("win-close");this.callEvent("afterClose",this.currWindow,l)};this.full=function(){var z=this.currWindow;k=this.config.root.$on("window:fullScreenClose",function(){this.unfull(z)}.bind(this));this._loadTpl.call(z,"fullScreenTpl",function(){l.fullScreen.addClass("win-effect-1 win-show")}.bind(this),"fullScreen");c.fullscreen=true;d.openFullScreen(l.fullScreen[0])};this.unfull=function(z){k();l.fullScreen.removeClass("win-effect-1 win-show");c.fullscreen=false;c.slideshow=false;d.cancelFullScreen()};this.prev=function(){this.currWindow._navigate("prev")};this.next=function(){this.currWindow._navigate("next")};s.on("keydown",function(B){var A=this.currWindow;if(A){if(A.keyControll&&A.group){var z=B.keyCode;switch(z){case 39:this.currWindow._navigate("next");break;case 37:this.currWindow._navigate("prev");break}}}}.bind(this))};n.prototype={delay:function(v){r.cancel(this.timerDelay);this.timerDelay=r(function(){v()},this.currWindow.resizeDelay)},_resizeWindow:function(){var v=this._winSize.call(this.currWindow),w=this.currWindow.content;c.inner.width=v.pageWidth;c.inner.height=v.viewHeight;if(this.currWindow.resize){c.content.width=v.wrap;if(this.currWindow.imgResize){var x=this.currWindow._getImageSize(w);c.param.width=x[0];c.param.height=x[1]}}this.callEvent("winResize",this.currWindow,l,v);this.updateScope()},_loadTpl:function(w,z,x){var A=l.wrap[0].querySelector("[mark="+this[w+"Mark"]+"]"),v=b.get(this[w+"Mark"]);if(!x){x="wrap"}if(!A&&!v){u.post(this[w]).success(function(B){l[x].html(B);var C=l[x].contents();C[0].setAttribute("mark",this[w+"Mark"]);p(C)(q.config.sc);b.put(this[w+"Mark"],B);z(B)}.bind(this))}else{if(!A&&v){l[x].html(v);var y=l[x].contents();p(y)(q.config.sc);z(v)}else{z(v)}}},_getContent:function(x){var v=x.target?x.target[0].tagName:"noelem",w;this.callEvent("beforeContentLoaded",x,l);switch(v){case"IMG":w=x.target.attr("src");break;case"A":w=x.target.attr("href");break;case"noelem":w=x.href;break;default:w=x.target[0].getAttribute(x.source)}w=w||x.href;if(w){switch(x.type){case"image":x._getImage(w,function(y){c.$broadcast("content:ready",y,x)});break;case"ajax":x._getAjax(w);break;case"inline":x._getInline(w);break}if(x.pushState){h.set(x)}}else{if(x.type==="inline"){x._getInline()}else{throw ("Не получилось отыскать ссылку на запрашиваемый контент!")}}},_updateUrl:function(){if(this.currWindow.pushState){var v=g.search();v.win_id=this.currWindow.win_id;g.search(v)}},_winSize:function(){var x=m,y=x.innerWidth,v=x.innerHeight,z,A;z=y-2*this.outPadding;if(c.fullscreen){A={width:y,height:v}}else{A=this.maxSizes}if(this.resize){if(z<this.minSizes.width){z=this.minSizes.width}else{if(z>A.width){z=A.width}}}else{z=A.width}return{pageWidth:y,viewHeight:v,wrap:z}},updateScope:function(){this.config.root.$$phase||this.config.root.$digest()},callEvent:function(){var v=arguments[0],w=this.currWindow||arguments[1];if(w[v]){if(typeof w[v]==="string"){new Function("call = "+w[v]+"; return call.apply(win, arguments);").apply(w,arguments)}else{w[v].apply(w,arguments)}}}};var f=function(v){this.callOptions=v;if(!this.callOptions.maxSizes){this.callOptions.maxSizes=j.maxSizes}angular.extend(this,j,v);if(this.target){this.target=this.target[0]?this.target:angular.element(this.target);this._getCurrUnicID()}else{this.noelem=true}this.ajax.method=this.ajax.method.toUpperCase();this.timestamp=Date.now();if(this.pushState){this.win_id=this.win_id||this.target[0].id;if(!this.win_id){this.pushState=false}}this.innerTplMark=this.innerTpl.replace(/[\/,\.]/g,"__");this.fullScreenTplMark=this.fullScreenTpl.replace(/[\/,\.]/g,"__");this._defWinScopeVariable();return this};f.prototype={_navigate:function(v){var w;switch(v){case"prev":w=this.index-1;break;case"next":w=this.index+1;break}var x=a[this.group][w];if(x){this.callOptions.target=x.target;if(c.fullscreen){l.fullScreen.removeClass("win-show").addClass("win-close")}else{l.wrap.removeClass("win-show").addClass("win-close")}q.callEvent("beforePagination",this.callOptions,l,x);r(function(){q.open(this.callOptions)}.bind(this),600)}else{if(c.slideshow){this.index=-1}else{if(v==="prev"){c.nav.prev=false}else{c.nav.next=false}}}},_getCurrUnicID:function(){var v=this.unicid=this.target[0].getAttribute("unicid");if(v){this.group=this.target[0].getAttribute("ng-group");angular.forEach(a[this.group],function(x,w){if(x.unicid===v){this.index=w}}.bind(this))}},_getAjax:function(x){var y=this,w=function(A){var z="";if(angular.isObject(A)){angular.forEach(A,function(C,B){if(angular.isObject(C)){z+=w(A[B])}else{z+=B+"="+C+"&"}});return z.substr(0,z.length-1)}else{throw ("Дополнительные параметры должны передаваться в виде объекта!")}};switch(y.ajax.method.toUpperCase()){case"POST":y.ajax.data=y.requestParam;y.ajax.transformRequest=function(z){return w(z)}.bind(this);break;case"GET":y.ajax.params=y.requestParam;break;default:throw ("Ваш метод отправки не поддерживается!")}y.ajax.url=x;var v={};angular.extend(v,j.ajax,y.ajax);u(v).success(function(A){if(angular.isObject(A)){if(A.src){y._getImage(A.src,function(B){angular.extend(A,B);c.$broadcast("content:ready",A,y)})}else{c.$broadcast("content:ready",A,y)}}else{l.content.html(A);var z=l.content.contents();p(z)(c);this._checkImgInContent(A)}}.bind(this))},_getInline:function(v){var x=this;if(v){u.post(v).success(function(z){if(l.content){l.content.html(z);var y=l.content.contents();p(y)(c);this._checkImgInContent(z)}else{throw ("При типе вызова inline в подгружаемом шаблоне должна быть диектива ng-sectors='content'")}}.bind(this))}else{var w={};this._checkImgInContent(w)}},_checkImgInContent:function(x){var v=l.content[0].querySelector("img."+this.imageClass),y=this;if(v){var w=v.src;this._getImage(w,function(z){z.data=x;c.$broadcast("content:ready",z,y)})}else{c.$broadcast("content:ready",x,y)}},_getImage:function(x,z){var w=new Image(),y=this,v={};w.onload=function(){angular.extend(v,{oric_height:w.height,oric_width:w.width,elem:w,src:x});v.ratio=v.oric_width/v.oric_height;var A=y._getImageSize(v);v.width=A[0];v.height=A[1];y.imgResize=true;z(v)};w.onerror=function(){throw ("Картинки с таким адресом не существует!")};w.src=x},_getImageSize:function(A){var z=c.content.width,w=c.inner.height,v=[];var x=z,y=w-(this.margin*2+this.padding*2);if(A.ratio<1){y-=this.outPadding}if(y<this.minSizes.height){y=this.minSizes.height}if((A.oric_width/x)>(A.oric_height/y)){v[0]=x;v[1]=Math.round(A.oric_height*x/A.oric_width)}else{v[0]=Math.round(A.oric_width*y/A.oric_height);v[1]=y}return v},_defWinScopeVariable:function(){var v=q._winSize.call(this);angular.extend(c,{content:{width:v.wrap,padding:this.padding},inner:{width:v.pageWidth,height:v.viewHeight,padding:this.margin+"px 0 "+this.margin+"px 0"}});l.wrap.addClass("win-effect-"+this.effect);this.scope=c}};var e=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)};return{create:function(v){return n(v)},getInstance:function(w,v,y){var x=o(function(){var z=w[v];if(z){o.cancel(x);y(z)}},100)},unicid:e}}]);