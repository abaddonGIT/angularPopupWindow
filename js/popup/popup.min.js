var popup=angular.module("popupWindow",[]);popup.factory("templateCache",["$cacheFactory",function(a){return a("template-cache")}]);popup.value("windowSectors",{inner:{el:null},wrap:{el:null},header:{el:null},content:{el:null},footer:{el:null},fullscreen:{el:null}});popup.directive("popupWindow",["$popupWindow",function(a){return{link:function(d,e,b){var c=d.$watch("windowStart",function(f){if(f){var g=b.group;var h=a.unicid();e[0].setAttribute("unicid",h);if(b.group){if(f.setElements[g]){f.setElements[g].push({unicid:h,el:e})}else{f.setElements[g]=[];f.setElements[g].push({unicid:h,el:e})}}c()}})}}}]);popup.directive("windowSection",["$popupWindow","windowSectors",function(b,a){return function(e,f,c){var d=c.windowSection;switch(d){case"header":a.header={el:f};break;case"content":a.content={el:f};break;case"footer":a.footer={el:f};break;case"wrap":a.wrap={el:f};break;case"fullscreen":a.fullscreen={el:f};break}}}]);popup.directive("popupWrap",["windowSectors",function(a){return{replace:true,template:'<div id="window-wrap" ng-show="winpopup.inner.show"><div id="wrap-inner" ng-style="{width:winpopup.inner.width + \'px\', height:winpopup.inner.height + \'px\', padding:winpopup.inner.padding}"><div id="wrap-block" data-window-section="wrap" ng-style="{width:winpopup.wrap.width + \'px\', padding:winpopup.wrap.padding + \'px\'}"></div></div></div>',link:function(d,e,b){var c=d.$watch("loadWindowTemp",function(f){a.inner={el:e,loaded:true};e.on("click",function(h){var g=h.target;if(g.id==="wrap-inner"){d.$emit("window:close")}})})}}}]);popup.directive("imageIncontent",["$popupWindow","$http","$compile",function(b,c,a){return function(e,f,d){e.$emit("window:imageContent",f,d)}}]);popup.directive("htmlContent",["$popupWindow","$http","$compile",function(b,c,a){return function(e,f,d){e.$emit("window:htmlContent",f,d)}}]);popup.factory("$winStorage",["$window","$location",function(c,e){var b=function(g){var f=JSON.stringify(g.openConfig,function(h,i){if(h=="el"){return undefined}return i});localStorage.setItem(g.win_id,f)};var d=function(f){return JSON.parse(localStorage[f])};var a=function(){localStorage.clear()};return{set:b,get:d,clear:a}}]);popup.factory("$fullScreen",["$document","$rootScope",function(g,a){var f=g[0];var b=function(d){if(d.requestFullscreen){d.requestFullscreen()}else{if(d.mozRequestFullScreen){d.mozRequestFullScreen()}else{if(d.webkitRequestFullscreen){d.webkitRequestFullscreen()}else{if(d.msRequestFullscreen){d.msRequestFullscreen()}}}}};var e=function(){if(f.exitFullscreen){f.exitFullscreen()}else{if(f.mozCancelFullScreen){f.mozCancelFullScreen()}else{if(f.webkitCancelFullScreen){f.webkitCancelFullScreen()}else{if(f.msExitFullscreen){f.msExitFullscreen()}}}}};var c=function(){if(f.fullscreenEnabled){f.addEventListener("fullscreenchange",function(){if(!f.fullScreen){}},false)}else{if(f.mozFullScreenEnabled){f.addEventListener("mozfullscreenchange",function(){if(!f.mozFullScreen){}},false)}else{if(f.webkitFullscreenEnabled){f.addEventListener("webkitfullscreenchange",function(){if(!f.webkitIsFullScreen){a.$emit("window:fullScreenClose")}},false)}else{if(f.msFullscreenEnabled){f.addEventListener("msfullscreenchange",function(){if(!f.msFullscreenElement){}},false)}}}}};return{openFullScreen:b,cancelFullScreen:e,fullScreeEvent:c}}]);popup.factory("$popupWindow",["$rootScope","$window","$document","$interval","$http","$compile","windowSectors","$timeout","$location","$winStorage","$rootElement","templateCache","$fullScreen",function(o,r,x,t,y,u,s,v,m,e,g,i,d){var f,c,a,p,q,w,n=angular.element(r),b;var l=function(B){if(!(this instanceof l)){return new l(B)}c=B.scope;angular.extend(this,{config:{},root:o,scope:B.scope,setElements:{},queue:[],timestamp:Date.now(),el:null,group:null,index:null,unicid:null,currContent:null,loadImages:{},pushState:true,tpls:[],body:x[0].querySelector("body")});q={resize:true,padding:15,margin:10,outPadding:100,winType:"image",innerTpl:"tpl/defaultWrapTpl.html",maxSizes:{width:1024,height:768},minSizes:{width:640,height:480},ajax:{method:"post",url:"test.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8"},data:{}},dataRequest:{},userControl:false,effect:1};f=this;a=null;p={};w=null;b=null;angular.extend(this.config,q,B);w=this.config;c.$on("window:navigate",this._windowPagination.bind(this));c.$on("window:imageLoaded",this._windowImageLoaded.bind(this));c.$on("window:contentLoaded",this._windowContentLoaded.bind(this));this.root.$on("window:fullScreenClose",function(){this.cancelFullScreen()}.bind(this));if(this.pushState){var A=m.search();if(A.win_id){var z=e.get(A.win_id);if(z){v(function(){var C=g[0].querySelector("#"+A.win_id);if(C){z.el=angular.element(C);this.open(z)}}.bind(this),0)}}}c.$on("window:close",function(){this.closeWindow()}.bind(this));d.fullScreeEvent();c.windowStart=this;c.loadWindowTemp=this};l.prototype={open:function(A){var z={};angular.extend(z,q,A);angular.extend(this,{el:A.el,group:A.el[0].getAttribute("data-group"),unicid:A.el[0].getAttribute("unicid"),config:z,win_id:A.el[0].id});w=this.config;if(this.group){this._getIndexFromNabor()}this._loadInnerTpl(function(){v(function(){this._defaultWindow();this._loadContent()}.bind(this),0)}.bind(this));n.on("resize",function(){this.currWrapWidth=null;this._windowResize()}.bind(this))},_loadInnerTpl:function(B){if(w.innerTpl){var z=i.get(w.innerTpl);if(!z){y.post(w.innerTpl).success(function(D){s.wrap.el.html(D);var C=s.wrap.el.contents();u(C)(this.scope);i.put(w.innerTpl,D);B()}.bind(this))}else{s.wrap.el.html(z);var A=s.wrap.el.contents();u(A)(this.scope);B()}}else{throw ("Не указан шаблон внутренней части окна!")}},_getIndexFromNabor:function(){angular.forEach(this.setElements[this.group],function(A,z){if(A.unicid===this.unicid){this.index=z}}.bind(this))},_defaultWindow:function(){var A=this.setElements[this.group];a=this.sizes=this.getTrueWindowSize();var z={counter:A?A.length:0,index:this.index+1,inner:{padding:w.margin+"px 0 "+w.margin+"px 0",width:a.pageWidth,height:a.viewHeight},wrap:{padding:w.padding,width:this.getWrapWidth()},navigation:{preloader:false,prev:false,next:false},content:{}};c.winpopup=z;switch(w.effect){case 1:s.wrap.el.addClass("win-effect-1");break;case 2:s.wrap.el.addClass("win-effect-2");break;case 3:s.wrap.el.addClass("win-effect-3");break;case 4:s.wrap.el.addClass("win-effect-4");break;case 5:s.wrap.el.addClass("win-effect-5");break}},_windowPagination:function(B,A,z,C){switch(z){case"next":this.index=this.index+1;break;case"prev":this.index=this.index-1;break}angular.extend(this,{el:A,unicid:A[0].getAttribute("unicid"),win_id:A[0].id});this.currWrapWidth=this.getWrapWidth();s.wrap.el.removeClass("win-show").addClass("win-close");this._trigger("window:beforePagination",A,s);v(function(){this._loadContent();c.winpopup.index=this.index+1}.bind(this),600)},_loadContent:function(){this._trigger("window:beforeContentLoaded",s);p=w.dataRequest||{};switch(w.winType){case"image":new k(this.el);break;case"ajax":w.ajax.data=w.dataRequest;w.ajax.transformRequest=function(z){return this.toParam(z)}.bind(this);y(w.ajax).success(function(B,z){b=B;if(B instanceof Object){if(B.src){new h(this.el,"image",B)}else{new h(this.el,"json",B)}}else{s.content.el.html(B);var A=s.content.el.contents();u(A)(c)}}.bind(this)).error(function(A,z){throw ("При попытке получения данных произошел сбой!")});c.$on("window:imageContent",function(B,A,z){new k(A)}.bind(this));c.$on("window:htmlContent",function(B,A,z){new h(A,"html")});break}},_windowImageLoaded:function(A,z){this.currContent=z;c.winpopup.content=z;if(w.resize){if(z.ratio<1){if(z.width<=w.minSizes.width){c.winpopup.wrap.width=w.minSizes.width}else{c.winpopup.wrap.width=z.width}}else{c.winpopup.wrap.width=z.width}}else{c.winpopup.wrap.width=w.maxSizes.width}this.afterLoad(z)},_windowContentLoaded:function(A,z){this.currContent=z;c.winpopup.content=z;this.afterLoad(z)},afterLoad:function(z){var A;if(this.group){if(this.index===0){if(this.setElements[this.group].length===1){A={next:false,prev:false}}else{A={next:true,prev:false}}}else{if(this.index===(this.setElements[this.group].length-1)){A={next:false,prev:true}}else{A={next:true,prev:true}}}c.winpopup.navigation=A}if(w.userControl){this._trigger("window:userControll",z,s,b)}else{c.winpopup.inner.show=true;this._updateUrl()}this._windowResize();this.updateScope();v(function(){s.wrap.el.removeClass("win-close").addClass("win-show")},50);this.body.style.overflow="hidden";this._trigger("window:afterContentLoaded",this.currContent,s,b)},bind:function(B,A){var z=B+":"+this.timestamp;c.$on(z,A.bind(this))},_trigger:function(z){arguments[0]=z+":"+this.timestamp;c.$broadcast.apply(c,arguments)},getWrapWidth:function(){var z=a.pageWidth-w.outPadding*2;if(z<w.minSizes.width){z=w.minSizes.width}else{if(z>w.maxSizes.width){z=w.maxSizes.width}}return z},_windowResize:function(){a=this.getTrueWindowSize();var C=a.pageWidth,B=a.viewHeight,A=null,z=null;c.winpopup.inner.width=C;c.winpopup.inner.height=B;if(w.resize){z=this.getWrapWidth();c.winpopup.wrap.width=z;if(!this.currContent.param.noResize){A=this.getNewSize(this.currContent);if(this.currContent.ratio<1){if(A[0]<=w.minSizes.width){c.winpopup.wrap.width=w.minSizes.width}else{c.winpopup.wrap.width=A[0]}}else{c.winpopup.wrap.width=A[0]}c.winpopup.content.width=c.winpopup.content.el.width=A[0];c.winpopup.content.height=c.winpopup.content.el.height=A[1]}}this.updateScope()},_updateUrl:function(){if(this.pushState&&this.currContent.win_id){var z=m.search();z.win_id=this.currContent.win_id;m.search(z);e.set(this.currContent)}},updateScope:function(){this.root.$$phase||this.root.$digest()},getTrueWindowSize:function(){var E,z,B,D,C,G,F=x[0],A=r;E=F.body.scrollWidth;z=F.body.scrollHeight;C=A.innerWidth;G=A.innerHeight;if(z<G){D=G}else{D=z}if(E<C){B=C}else{B=E}return{pageWidth:B,pageHeight:D,viewWidth:C,viewHeight:G,pageWidthScroll:E,pageHeightScroll:z}},getNewSize:function(F,C){var E=this.currWrapWidth||c.winpopup.wrap.width,A=a.viewHeight,z={};if(C){E=a.pageWidth}var B=E,D=A-(w.margin*2+w.padding*2);if(F.ratio<1){D-=w.outPadding}if(D<w.minSizes.height){D=w.minSizes.height}if((F.oric_width/B)>(F.oric_height/D)){z[0]=B;z[1]=Math.round(F.oric_height*B/F.oric_width)}else{z[0]=Math.round(F.oric_width*D/F.oric_height);z[1]=D}return z},toParam:function(A){if(A){var z="";angular.forEach(A,function(C,B){z+=B+"="+C+"&"});z=z.substr(0,z.length-1);return z}},closeWindow:function(){n.off("resize");p={};c.winpopup.inner.show=false;this.currWrapWidth=null;this._defaultWindow();s.wrap.el.removeClass("win-show").addClass("win-close");this.updateScope();this.body.style.overflow="auto";if(this.pushState){var z=m.search();delete z.win_id;m.search(z)}},getNext:function(A){if(angular.isFunction(A)){A(s)}else{var z=this.setElements[this.group][this.index+1];c.$emit("window:navigate",z.el,"next",A||{})}},getPrev:function(A){if(angular.isFunction(A)){A(s)}else{var z=this.setElements[this.group][this.index-1];c.$emit("window:navigate",z.el,"prev",A||{})}},fullScreen:function(){var z=this.getNewSize(this.currContent,1);w.maxSizes={width:z[0],height:z[1]};c.winpopup.fullscreen=true;d.openFullScreen(s.fullscreen.el[0])},cancelFullScreen:function(){var z=this.currContent;w.maxSizes=z.openConfig.maxSizes;c.winpopup.fullscreen=false;d.cancelFullScreen()},data:{}};var k=function(B){angular.extend(this,{unicid:B[0].getAttribute("unicid")||j(),win_id:B[0].id,openConfig:angular.extend({},w)});var z=B[0].tagName,A;switch(z){case"A":A=B[0].href;break;case"IMG":A=B[0].src;break}if(A){this.createImageObject(A)}else{throw ("Вы не передали ссылку на картинку!")}};k.prototype.createImageObject=function(A){var B,z;z=new Image();z.onload=function(){angular.extend(this,{oric_height:z.height,oric_width:z.width,src:A,el:z,param:p});this.ratio=this.oric_width/this.oric_height;B=f.getNewSize(this);this.width=this.el.width=B[0];this.height=this.el.height=B[1];c.$broadcast("window:imageLoaded",this);z=null}.bind(this);z.onerror=function(){throw ("Такого изображения не существует!")};z.src=A};var h=function(C,A,z){angular.extend(this,{unicid:C[0].getAttribute("unicid")||j(),win_id:C[0].id,openConfig:angular.extend({},w),param:{}});switch(A){case"image":var B=z.src;angular.extend(this.param,p,z);this.getImage(B,function(D){c.$broadcast("window:imageLoaded",this)}.bind(this));break;case"json":this.param.noResize=true;angular.extend(this.param,p,z);c.$broadcast("window:contentLoaded",this);break;case"html":this.param.noResize=true;angular.extend(this.param,p);c.$broadcast("window:contentLoaded",this);break}};h.prototype.getImage=function(A,C){var z=new Image(),B;z.onload=function(){angular.extend(this,{oric_height:z.height,oric_width:z.width,src:A,el:z});this.ratio=this.oric_width/this.oric_height;B=f.getNewSize(this);this.width=this.el.width=B[0];this.height=this.el.height=B[1];C(this);z=null}.bind(this);z.onerror=function(){throw ("Картинки с таким адресом не существует!")};z.src=A};var j=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)};return{init:function(z){return l(z)},unicid:j}}]);