var popup=angular.module("popupWindow",[]);popup.factory("templateCache",["$cacheFactory",function(a){return a("template-cache")}]);popup.value("errorsString",{noimage:"Битый адрес картинки"});popup.value("windowSectors",{inner:{el:null,loaded:false},wrap:{el:null,loaded:false},header:{el:null,loaded:false},content:{el:null,loaded:false},footer:{el:null,loaded:false}});popup.directive("popupWindow",["$popupWindow",function(a){return{link:function(d,e,b){var c=d.$watch("windowStart",function(f){if(f){var g=b.group;var h=a.unicid();e[0].setAttribute("unicid",h);if(b.group){if(f.setElements[g]){f.setElements[g].push({unicid:h,el:e})}else{f.setElements[g]=[];f.setElements[g].push({unicid:h,el:e})}}c()}})}}}]);popup.directive("windowSection",["$popupWindow","windowSectors",function(b,a){return function(e,f,c){var d=c.windowSection;switch(d){case"header":a.header={el:f,loaded:true};break;case"content":a.content={el:f,loaded:true};break;case"footer":a.footer={el:f,loaded:true};break;case"wrap":a.wrap={el:f,loaded:true};break}}}]);popup.directive("popupWrap",["windowSectors",function(a){return{replace:true,template:'<div id="window-wrap" ng-show="inner.show"><div id="wrap-inner" ng-style="{width:inner.width + \'px\', height:inner.height + \'px\', padding:inner.padding}"><div id="wrap-block" data-window-section="wrap" ng-style="{width:wrap.width + \'px\', padding:wrap.padding + \'px\'}"></div></div></div>',link:function(d,e,b){var c=d.$watch("loadWindowTemp",function(f){a.inner={el:e,loaded:true}})}}}]);popup.directive("imageIncontent",["$popupWindow","$http","$compile",function(b,c,a){return function(e,f,d){e.$emit("window:imageContent",f,d)}}]);popup.directive("htmlContent",["$popupWindow","$http","$compile",function(b,c,a){return function(e,f,d){e.$emit("window:htmlContent",f,d)}}]);popup.factory("$winStorage",["$window","$location",function(c,e){var b=function(g){var f=JSON.stringify(g.openConfig,function(h,i){if(h=="el"){return undefined}return i});localStorage.setItem(g.win_id,f)};var d=function(f){return JSON.parse(localStorage[f])};var a=function(){localStorage.clear()};return{set:b,get:d,clear:a}}]);popup.factory("$popupWindow",["$rootScope","$window","$document","$interval","$http","$compile","errorsString","windowSectors","$timeout","$location","$winStorage","$rootElement","templateCache",function(m,p,v,r,w,s,e,q,t,k,d,g,h){var f,b,a,n,o,u,l=angular.element(p);var j=function(z){if(!(this instanceof j)){return new j(z)}b=z.scope;angular.extend(this,{config:{},root:m,scope:z.scope,setElements:{},queue:[],timestamp:Date.now(),el:null,group:null,index:null,unicid:null,currContent:null,loadImages:{},pushState:true,tpls:[],body:v[0].querySelector("body")});o={resize:true,padding:15,margin:10,outPadding:100,winType:"image",innerTpl:"tpl/defaultWrapTpl.html",maxSizes:{width:1024,height:768},minSizes:{width:640,height:480},ajax:{method:"post",url:"test.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8"},data:{}},dataRequest:{},userControl:false,effect:1};f=this;a=null;n={};u=null;angular.extend(this.config,o,z);u=this.config;b.$on("window:navigate",this._windowPagination.bind(this));b.$on("window:imageLoaded",this._windowImageLoaded.bind(this));b.$on("window:htmlLoaded",this._windowHtmlLoaded.bind(this));b.windowStart=this;b.loadWindowTemp=this;if(this.pushState){var y=k.search();if(y.win_id){var x=d.get(y.win_id);if(x){t(function(){var A=g[0].querySelector("#"+y.win_id);if(A){x.el=angular.element(A);this.open(x)}}.bind(this),0)}}}};j.prototype={open:function(y){l.on("resize",function(){this.currWrapWidth=null;this._windowResize()}.bind(this));var x={};angular.extend(x,o,y);angular.extend(this,{el:y.el,group:y.el[0].getAttribute("data-group"),unicid:y.el[0].getAttribute("unicid"),config:x,win_id:y.el[0].id});u=this.config;if(this.group){this._getIndexFromNabor()}this._loadInnerTpl(function(){t(function(){this._defaultWindow();this._loadContent()}.bind(this),0)}.bind(this))},_loadInnerTpl:function(z){if(u.innerTpl){var x=h.get(u.innerTpl);if(!x){w.post(u.innerTpl).success(function(B){q.wrap.el.html(B);var A=q.wrap.el.contents();s(A)(this.scope);h.put(u.innerTpl,B);z()}.bind(this))}else{q.wrap.el.html(x);var y=q.wrap.el.contents();s(y)(this.scope);z()}}else{throw ("Не указан шаблон внутренней части окна!")}},_getIndexFromNabor:function(){angular.forEach(this.setElements[this.group],function(y,x){if(y.unicid===this.unicid){this.index=x}}.bind(this))},_defaultWindow:function(){a=this.sizes=this.getTrueWindowSize();var y={padding:u.margin+"px 0 "+u.margin+"px 0",width:a.pageWidth,height:a.viewHeight};var z={padding:u.padding,width:this.getWrapWidth()};switch(u.effect){case 1:q.wrap.el.addClass("win-effect-1");break;case 2:q.wrap.el.addClass("win-effect-2");break;case 3:q.wrap.el.addClass("win-effect-3");break;case 4:q.wrap.el.addClass("win-effect-4");break;case 5:q.wrap.el.addClass("win-effect-5");break}var C={};var A={img:{},param:{}};var x={prev:{show:false},next:{show:false},preloader:false};var B={};b.wrap=z;b.inner=y;b.navigation=x;b.header=C;b.content=A;b.footer=B},_windowPagination:function(z,y,x,A){switch(x){case"next":this.index=this.index+1;break;case"prev":this.index=this.index-1;break}this.el=y;this.unicid=this.el[0].getAttribute("unicid");this.win_id=this.el[0].id;this.currWrapWidth=this.getWrapWidth();b.navigation.preloader=true;q.wrap.el.removeClass("win-show").addClass("win-close");this._trigger("window:beforePagination",y,q);t(function(){this._loadContent()}.bind(this),600)},_loadContent:function(){this._trigger("window:beforeContentLoaded",q);n=u.dataRequest||{};switch(u.winType){case"image":this.currContent=new c();break;case"ajax":u.ajax.data=u.dataRequest;u.ajax.transformRequest=function(x){return this.toParam(x)}.bind(this);w(u.ajax).success(function(A,x){if(A instanceof Object){this.currContent=new c(A,"json")}else{if(u.userControl){var z=new c(A,"giglet");this.currContent=z;this._trigger("window:userHtmlLoaded",z,q)}else{var y=q.content.el;y.html(A);s(y.contents())(b)}}}.bind(this)).error(function(y,x){throw ("При попытке получения данных произошел сбой!")});b.$on("window:imageContent",function(z,y,x){this.currContent=new c(y,"image")}.bind(this));b.$on("window:htmlContent",function(z,y,x){this.currContent=new c(y,"html")});break}},_windowImageLoaded:function(y,x){this.currContent=x;b.navigation.preloader=false;if(!x.img.error){var z=x.param;b.winError=false;this.queue.push(x);angular.extend(b.content.img,x.img);angular.extend(b.content,z.content);angular.extend(b.header,z.header);angular.extend(b.footer,z.footer);angular.extend(b.content.param,z);if(x.img.ratio<1){if(x.img.width<=u.minSizes.width){b.wrap.width=u.minSizes.width}else{b.wrap.width=x.img.width}}else{b.wrap.width=x.img.width}if(this.group){if(this.index===0){if(this.setElements[this.group].length===1){b.navigation.next.show=false;b.navigation.prev.show=false}else{b.navigation.next.show=true;b.navigation.prev.show=false}}else{if(this.index===(this.setElements[this.group].length-1)){b.navigation.next.show=false;b.navigation.prev.show=true}else{b.navigation.next.show=true;b.navigation.prev.show=true}}}if(u.userControl){this._trigger("window:userImageLoaded",x,q)}else{b.inner.show=true}this._updateUrl()}else{b.winError=e.noimage;b.inner.show=true}this._windowResize();this.updateScope();t(function(){q.wrap.el.removeClass("win-close");q.wrap.el.addClass("win-show")},50);this.body.style.overflow="hidden";this._trigger("window:afterContentLoaded",this.currContent,q)},_windowHtmlLoaded:function(y,x){this.queue.push(x);b.navigation.preloader=false;angular.extend(b.content,x.param);this.currContent=x;b.inner.show=true;this._windowResize();this.updateScope();t(function(){q.wrap.el.removeClass("win-close");q.wrap.el.addClass("win-show")},50);this.body.style.overflow="hidden";this._trigger("window:afterContentLoaded",this.currContent,q);this._updateUrl()},bind:function(z,y){var x=z+":"+this.timestamp;b.$on(x,y.bind(this))},_trigger:function(x){arguments[0]=x+":"+this.timestamp;b.$broadcast.apply(b,arguments)},getWrapWidth:function(){var x=a.pageWidth-u.outPadding*2;if(x<u.minSizes.width){x=u.minSizes.width}else{if(x>u.maxSizes.width){x=u.maxSizes.width}}return x},_windowResize:function(){a=this.getTrueWindowSize(),newWinWidth=a.pageWidth,newWinHeight=a.viewHeight,newSizes=null,wrap=null;b.inner.width=newWinWidth;b.inner.height=newWinHeight;if(u.resize){wrap=this.getWrapWidth();b.wrap.width=wrap;if(!this.currContent.param.noResize){newSizes=this.getNewSize(this.currContent);if(this.currContent.img.ratio<1){if(newSizes[0]<=u.minSizes.width){b.wrap.width=u.minSizes.width}else{b.wrap.width=newSizes[0]}}else{b.wrap.width=newSizes[0]}b.content.img.width=b.content.img.el.width=newSizes[0];b.content.img.height=b.content.img.el.height=newSizes[1]}}this.updateScope()},_updateUrl:function(){if(this.pushState&&this.currContent.win_id){var x=k.search();x.win_id=this.currContent.win_id;k.search(x);d.set(this.currContent)}},updateScope:function(){this.root.$$phase||this.root.$digest()},getTrueWindowSize:function(){var F,B,E,z,y,x,G={},D=v[0].documentElement,A=v[0],C=p;if(C.innerHeight&&C.scrollMaxY){F=A.body.scrollWidth;B=C.innerHeight+C.scrollMaxY}else{if(A.body.scrollHeight>A.body.offsetHeight){F=A.body.scrollWidth;B=A.body.scrollHeight}else{if(D&&D.scrollHeight>D.offsetHeight){F=D.scrollWidth;B=D.scrollHeight}else{F=A.body.offsetWidth;B=A.body.offsetHeight}}}if(self.innerHeight){y=self.innerWidth;x=self.innerHeight}else{if(D&&D.clientHeight){y=D.clientWidth;x=D.clientHeight}else{if(A.body){y=A.body.clientWidth;x=A.body.clientHeight}}}if(B<x){z=x}else{z=B}if(F<y){E=y}else{E=F}return G={pageWidth:E,pageHeight:z,viewWidth:y,viewHeight:x,pageWidthScroll:F,pageHeightScroll:B}},getNewSize:function(C){var B=this.currWrapWidth||b.wrap.width,y=a.viewHeight,x={};var z=B,A=y-(u.margin*2+u.padding*2);if(C.img.ratio<1){A-=u.outPadding}if(A<u.minSizes.height){A=u.minSizes.height}if((C.img.oric_width/z)>(C.img.oric_height/A)){x[0]=z;x[1]=Math.round(C.img.oric_height*z/C.img.oric_width)}else{x[0]=Math.round(C.img.oric_width*A/C.img.oric_height);x[1]=A}return x},toParam:function(y){if(y){var x="";angular.forEach(y,function(A,z){x+=z+"="+A+"&"});x=x.substr(0,x.length-1);return x}},closeWindow:function(){l.off("resize");n={};b.inner.show=false;this.currWrapWidth=null;this._defaultWindow();q.wrap.el.removeClass("win-show").addClass("win-close");this.updateScope();this.body.style.overflow="auto";if(this.pushState){var x=k.search();delete x.win_id;k.search(x)}},getNext:function(y){if(angular.isFunction(y)){y(q)}else{var x=this.setElements[this.group][this.index+1];b.$emit("window:navigate",x.el,"next",y||{})}},getPrev:function(y){if(angular.isFunction(y)){y(q)}else{var x=this.setElements[this.group][this.index-1];b.$emit("window:navigate",x.el,"prev",y||{})}},data:{}};var c=function(z,x){this.unicid=f.el[0].getAttribute("unicid")||i();this.win_id=f.win_id;this.openConfig=u;switch(u.winType){case"image":this.img={};var y=f.el[0].href;if(!y){throw ("Вы не заполнили атребут href у источника!")}else{this.createImage(y)}break;case"ajax":switch(x){case"image":this.img={};var y=z[0].src;if(!y){throw ("Вы не заполнили атребут src у источника!")}else{this.createImage(y)}break;case"html":this.createHtml(z);break;case"json":if(z.params){angular.extend(n,z.params)}if(z.src){this.img={};this.createImage(z.src)}break;case"giglet":return this.createGiglet(z);break}break}};c.prototype={imageRendering:function(x,y){this.img.oric_width=x.width;this.img.oric_height=x.height;this.img.src=y;this.img.el=x;this.img.ratio=this.img.oric_width/this.img.oric_height;var z=f.getNewSize(this);this.img.width=this.img.el.width=z[0];this.img.height=this.img.el.height=z[1];this.param={};angular.extend(this.param,n)},createImage:function(y){if(f.loadImages[y]){this.imageRendering(f.loadImages[y],y);b.$broadcast("window:imageLoaded",this)}else{var x=new Image();x.onload=function(){this.imageRendering(x,y);b.$broadcast("window:imageLoaded",this);f.loadImages[y]=x;x=0}.bind(this);x.onerror=function(){this.img.error=true;this.img.el=x;b.$broadcast("window:imageLoaded",this);x=0}.bind(this);x.src=y}},createHtml:function(x){this.param={};this.el=x;n.noResize=true;angular.extend(this.param,n);b.$broadcast("window:htmlLoaded",this)},createGiglet:function(x){this.param={};this.el=x;n.noResize=true;angular.extend(this.param,n)}};var i=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)};return{init:function(x){return j(x)},unicid:i}}]);