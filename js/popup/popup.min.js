var popup=angular.module("popupWindow",[]);popup.factory("templateCache",["$cacheFactory",function(a){return a("template-cache")}]);popup.value("windowSectors",{inner:{el:null},wrap:{el:null},header:{el:null},content:{el:null},footer:{el:null}});popup.directive("popupWindow",["$popupWindow",function(a){return{link:function(d,e,b){var c=d.$watch("windowStart",function(f){if(f){var g=b.group;var h=a.unicid();e[0].setAttribute("unicid",h);if(b.group){if(f.setElements[g]){f.setElements[g].push({unicid:h,el:e})}else{f.setElements[g]=[];f.setElements[g].push({unicid:h,el:e})}}c()}})}}}]);popup.directive("windowSection",["$popupWindow","windowSectors",function(b,a){return function(e,f,c){var d=c.windowSection;switch(d){case"header":a.header={el:f};break;case"content":a.content={el:f};break;case"footer":a.footer={el:f};break;case"wrap":a.wrap={el:f};break}}}]);popup.directive("popupWrap",["windowSectors",function(a){return{replace:true,template:'<div id="window-wrap" ng-show="winpopup.inner.show"><div id="wrap-inner" ng-style="{width:winpopup.inner.width + \'px\', height:winpopup.inner.height + \'px\', padding:winpopup.inner.padding}"><div id="wrap-block" data-window-section="wrap" ng-style="{width:winpopup.wrap.width + \'px\', padding:winpopup.wrap.padding + \'px\'}"></div></div></div>',link:function(d,e,b){var c=d.$watch("loadWindowTemp",function(f){a.inner={el:e,loaded:true};e.on("click",function(h){var g=h.target;if(g.id==="wrap-inner"){d.$emit("window:close")}})})}}}]);popup.directive("imageIncontent",["$popupWindow","$http","$compile",function(b,c,a){return function(e,f,d){e.$emit("window:imageContent",f,d)}}]);popup.directive("htmlContent",["$popupWindow","$http","$compile",function(b,c,a){return function(e,f,d){e.$emit("window:htmlContent",f,d)}}]);popup.factory("$winStorage",["$window","$location",function(c,e){var b=function(g){var f=JSON.stringify(g.openConfig,function(h,i){if(h=="el"){return undefined}return i});localStorage.setItem(g.win_id,f)};var d=function(f){return JSON.parse(localStorage[f])};var a=function(){localStorage.clear()};return{set:b,get:d,clear:a}}]);popup.factory("$popupWindow",["$rootScope","$window","$document","$interval","$http","$compile","windowSectors","$timeout","$location","$winStorage","$rootElement","templateCache",function(n,q,w,s,x,t,r,u,l,d,f,h){var e,c,a,o,p,v,m=angular.element(q),b;var k=function(A){if(!(this instanceof k)){return new k(A)}c=A.scope;angular.extend(this,{config:{},root:n,scope:A.scope,setElements:{},queue:[],timestamp:Date.now(),el:null,group:null,index:null,unicid:null,currContent:null,loadImages:{},pushState:true,tpls:[],body:w[0].querySelector("body")});p={resize:true,padding:15,margin:10,outPadding:100,winType:"image",innerTpl:"tpl/defaultWrapTpl.html",maxSizes:{width:1024,height:768},minSizes:{width:640,height:480},ajax:{method:"post",url:"test.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8"},data:{}},dataRequest:{},userControl:false,effect:1};e=this;a=null;o={};v=null;b=null;angular.extend(this.config,p,A);v=this.config;c.$on("window:navigate",this._windowPagination.bind(this));c.$on("window:imageLoaded",this._windowImageLoaded.bind(this));c.$on("window:contentLoaded",this._windowContentLoaded.bind(this));c.windowStart=this;c.loadWindowTemp=this;if(this.pushState){var z=l.search();if(z.win_id){var y=d.get(z.win_id);if(y){u(function(){var B=f[0].querySelector("#"+z.win_id);if(B){y.el=angular.element(B);this.open(y)}}.bind(this),0)}}}c.$on("window:close",function(){this.closeWindow()}.bind(this))};k.prototype={open:function(z){var y={};angular.extend(y,p,z);angular.extend(this,{el:z.el,group:z.el[0].getAttribute("data-group"),unicid:z.el[0].getAttribute("unicid"),config:y,win_id:z.el[0].id});v=this.config;if(this.group){this._getIndexFromNabor()}this._loadInnerTpl(function(){u(function(){this._defaultWindow();this._loadContent()}.bind(this),0)}.bind(this));if(v.resize){m.on("resize",function(){this.currWrapWidth=null;this._windowResize()}.bind(this))}},_loadInnerTpl:function(A){if(v.innerTpl){var y=h.get(v.innerTpl);if(!y){x.post(v.innerTpl).success(function(C){r.wrap.el.html(C);var B=r.wrap.el.contents();t(B)(this.scope);h.put(v.innerTpl,C);A()}.bind(this))}else{r.wrap.el.html(y);var z=r.wrap.el.contents();t(z)(this.scope);A()}}else{throw ("Не указан шаблон внутренней части окна!")}},_getIndexFromNabor:function(){angular.forEach(this.setElements[this.group],function(z,y){if(z.unicid===this.unicid){this.index=y}}.bind(this))},_defaultWindow:function(){var z=this.setElements[this.group];a=this.sizes=this.getTrueWindowSize();var y={counter:z?z.length:0,index:this.index+1,inner:{padding:v.margin+"px 0 "+v.margin+"px 0",width:a.pageWidth,height:a.viewHeight},wrap:{padding:v.padding,width:this.getWrapWidth()},navigation:{preloader:false,prev:false,next:false},content:{}};c.winpopup=y;switch(v.effect){case 1:r.wrap.el.addClass("win-effect-1");break;case 2:r.wrap.el.addClass("win-effect-2");break;case 3:r.wrap.el.addClass("win-effect-3");break;case 4:r.wrap.el.addClass("win-effect-4");break;case 5:r.wrap.el.addClass("win-effect-5");break}},_windowPagination:function(A,z,y,B){switch(y){case"next":this.index=this.index+1;break;case"prev":this.index=this.index-1;break}angular.extend(this,{el:z,unicid:z[0].getAttribute("unicid"),win_id:z[0].id});this.currWrapWidth=this.getWrapWidth();r.wrap.el.removeClass("win-show").addClass("win-close");this._trigger("window:beforePagination",z,r);u(function(){this._loadContent();c.winpopup.index=this.index+1}.bind(this),600)},_loadContent:function(){this._trigger("window:beforeContentLoaded",r);o=v.dataRequest||{};switch(v.winType){case"image":new j(this.el);break;case"ajax":v.ajax.data=v.dataRequest;v.ajax.transformRequest=function(y){return this.toParam(y)}.bind(this);x(v.ajax).success(function(A,y){b=A;if(A instanceof Object){if(A.src){new g(this.el,"image",A)}else{new g(this.el,"json",A)}}else{r.content.el.html(A);var z=r.content.el.contents();t(z)(c)}}.bind(this)).error(function(z,y){throw ("При попытке получения данных произошел сбой!")});c.$on("window:imageContent",function(A,z,y){new j(z)}.bind(this));c.$on("window:htmlContent",function(A,z,y){new g(z,"html")});break}},_windowImageLoaded:function(z,y){this.currContent=y;c.winpopup.content=y;if(y.ratio<1){if(y.width<=v.minSizes.width){c.winpopup.wrap.width=v.minSizes.width}else{c.winpopup.wrap.width=y.width}}else{c.winpopup.wrap.width=y.width}this.afterLoad(y)},_windowContentLoaded:function(z,y){this.currContent=y;c.winpopup.content=y;this.afterLoad(y)},afterLoad:function(y){var z;if(this.group){if(this.index===0){if(this.setElements[this.group].length===1){z={next:false,prev:false}}else{z={next:true,prev:false}}}else{if(this.index===(this.setElements[this.group].length-1)){z={next:false,prev:true}}else{z={next:true,prev:true}}}c.winpopup.navigation=z}if(v.userControl){this._trigger("window:userControll",y,r,b)}else{c.winpopup.inner.show=true;this._updateUrl()}this._windowResize();this.updateScope();u(function(){r.wrap.el.removeClass("win-close").addClass("win-show")},50);this.body.style.overflow="hidden";this._trigger("window:afterContentLoaded",this.currContent,r,b)},bind:function(A,z){var y=A+":"+this.timestamp;c.$on(y,z.bind(this))},_trigger:function(y){arguments[0]=y+":"+this.timestamp;c.$broadcast.apply(c,arguments)},getWrapWidth:function(){var y=a.pageWidth-v.outPadding*2;if(y<v.minSizes.width){y=v.minSizes.width}else{if(y>v.maxSizes.width){y=v.maxSizes.width}}return y},_windowResize:function(){var B=a.pageWidth,A=a.viewHeight,z=null,y=null;a=this.getTrueWindowSize();c.winpopup.inner.width=B;c.winpopup.inner.height=A;if(v.resize){y=this.getWrapWidth();c.winpopup.wrap.width=y;if(!this.currContent.param.noResize){z=this.getNewSize(this.currContent);if(this.currContent.ratio<1){if(z[0]<=v.minSizes.width){c.winpopup.wrap.width=v.minSizes.width}else{c.winpopup.wrap.width=z[0]}}else{c.winpopup.wrap.width=z[0]}c.winpopup.content.width=c.winpopup.content.el.width=z[0];c.winpopup.content.height=c.winpopup.content.el.height=z[1]}}this.updateScope()},_updateUrl:function(){if(this.pushState&&this.currContent.win_id){var y=l.search();y.win_id=this.currContent.win_id;l.search(y);d.set(this.currContent)}},updateScope:function(){this.root.$$phase||this.root.$digest()},getTrueWindowSize:function(){var D,y,A,C,B,F,E=w[0],z=q;D=E.body.scrollWidth;y=E.body.scrollHeight;B=z.innerWidth;F=z.innerHeight;if(y<F){C=F}else{C=y}if(D<B){A=B}else{A=D}return{pageWidth:A,pageHeight:C,viewWidth:B,viewHeight:F,pageWidthScroll:D,pageHeightScroll:y}},getNewSize:function(D){var C=this.currWrapWidth||c.winpopup.wrap.width,z=a.viewHeight,y={};var A=C,B=z-(v.margin*2+v.padding*2);if(D.ratio<1){B-=v.outPadding}if(B<v.minSizes.height){B=v.minSizes.height}if((D.oric_width/A)>(D.oric_height/B)){y[0]=A;y[1]=Math.round(D.oric_height*A/D.oric_width)}else{y[0]=Math.round(D.oric_width*B/D.oric_height);y[1]=B}return y},toParam:function(z){if(z){var y="";angular.forEach(z,function(B,A){y+=A+"="+B+"&"});y=y.substr(0,y.length-1);return y}},closeWindow:function(){m.off("resize");o={};c.winpopup.inner.show=false;this.currWrapWidth=null;this._defaultWindow();r.wrap.el.removeClass("win-show").addClass("win-close");this.updateScope();this.body.style.overflow="auto";if(this.pushState){var y=l.search();delete y.win_id;l.search(y)}},getNext:function(z){if(angular.isFunction(z)){z(r)}else{var y=this.setElements[this.group][this.index+1];c.$emit("window:navigate",y.el,"next",z||{})}},getPrev:function(z){if(angular.isFunction(z)){z(r)}else{var y=this.setElements[this.group][this.index-1];c.$emit("window:navigate",y.el,"prev",z||{})}},fullScreen:function(){r.wrap.el[0].webkitRequestFullscreen()},data:{}};var j=function(A){angular.extend(this,{unicid:A[0].getAttribute("unicid")||i(),win_id:A[0].id,openConfig:v});var y=A[0].tagName,z;switch(y){case"A":z=A[0].href;break;case"IMG":z=A[0].src;break}if(z){this.createImageObject(z)}else{throw ("Вы не передали ссылку на картинку!")}};j.prototype.createImageObject=function(z){var A,y;y=new Image();y.onload=function(){angular.extend(this,{oric_height:y.height,oric_width:y.width,src:z,el:y,param:o});this.ratio=this.oric_width/this.oric_height;A=e.getNewSize(this);this.width=this.el.width=A[0];this.height=this.el.height=A[1];c.$broadcast("window:imageLoaded",this);y=null}.bind(this);y.onerror=function(){throw ("Такого изображения не существует!")};y.src=z};var g=function(B,z,y){angular.extend(this,{unicid:B[0].getAttribute("unicid")||i(),win_id:B[0].id,openConfig:v,param:{}});switch(z){case"image":var A=y.src;angular.extend(this.param,o,y);this.getImage(A,function(C){c.$broadcast("window:imageLoaded",this)}.bind(this));break;case"json":this.param.noResize=true;angular.extend(this.param,o,y);c.$broadcast("window:contentLoaded",this);break;case"html":this.param.noResize=true;angular.extend(this.param,o);c.$broadcast("window:contentLoaded",this);break}};g.prototype.getImage=function(z,B){var y=new Image(),A;y.onload=function(){angular.extend(this,{oric_height:y.height,oric_width:y.width,src:z,el:y});this.ratio=this.oric_width/this.oric_height;A=e.getNewSize(this);this.width=this.el.width=A[0];this.height=this.el.height=A[1];B(this);y=null}.bind(this);y.onerror=function(){throw ("Картинки с таким адресом не существует!")};y.src=z};var i=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)};return{init:function(y){return k(y)},unicid:i}}]);