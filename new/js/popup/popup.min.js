var win=angular.module("popupWindow",[]);win.factory("$tplCache",["$cacheFactory",function(a){return a("tplCache")}]);win.value("$sectors",{});win.directive("ngSectors",["$sectors",function(a){return function(c,d,b){a[b.ngSectors]=d}}]);win.directive("ngPopupWin",["$popupWindow","$rootScope",function(b,a){return{scope:{options:"=?",win:"=?",ngClick:"="},replace:false,template:'<div id="window-wrap" ng-show="show"></div><div ng-show="show" id="wrap-inner" ng-style="{width:inner.width + \'px\', height:inner.height + \'px\', padding:inner.padding}"><div id="wrap-block" ng-sectors="wrap" ng-style="{width: content.width + \'px\', padding: content.padding + \'px\'}"></div></div>',link:function(d,e,c){if(d.options){d.options.sc=d}else{d.options={sc:d}}var f=b.create(d.options);d.close=function(){f.close()}}}}]);win.factory("$popupWindow",["$rootScope","$timeout","$tplCache","$sectors","$document","$window","$http","$compile",function(l,c,e,g,d,a,i,f){var b,k,n,h={pushState:false,target:null,resize:true,margin:10,effect:1,source:null,scope:null,type:"image",win_id:null,innerTpl:"tpl/defInnerTpl.html",fullScreenTpl:"tpl/defFullScreenTpl.html",outPadding:100,padding:10,resizeDelay:100,ajax:{method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8"}},maxSizes:{width:1024,height:768},minSizes:{width:640,height:480}};var j=function(o){if(!(this instanceof j)){return new j(o)}b=this.config={locScope:null,root:l,windows:[],currWindow:null,timestamp:Date.now(),timerDelay:0};angular.extend(b,o);n=this.config.sc;this.open=function(p){var q=new m(p);this._loadTpl.call(q,"innerTpl",function(){this._getContent(q)}.bind(this))};this.close=function(){n.show=false;g.wrap.removeClass("win-show").addClass("win-close")};angular.element(a).on("resize",function(){if(this.currWindow){this.delay(function(){this._resizeWindow()}.bind(this))}}.bind(this));b.locScope.win=this;k=this};j.prototype={delay:function(o){c.cancel(this.timerDelay);this.timerDelay=c(function(){o()},this.currWindow.resizeDelay)},_resizeWindow:function(){var o=this._winSize.call(this.currWindow),p=this.currWindow.content;n.inner.width=o.pageWidth;n.inner.height=o.viewHeight;if(this.currWindow.resize){n.content.width=o.wrap;var q=this.currWindow._getImageSize(p);n.param.width=q[0];n.param.height=q[1]}this.updateScope()},_loadTpl:function(p,r){var s=g.wrap[0].querySelector("[mark="+this[p+"Mark"]+"]"),o=e.get(this[p+"Mark"]);if(!s&&!o){i.post(this[p]).success(function(t){g.wrap.html(t);var u=g.wrap.contents();u[0].setAttribute("mark",this[p+"Mark"]);f(u)(k.config.sc);e.put(this[p+"Mark"],t);r()}.bind(this))}else{if(!s&&o){g.wrap.html(o);var q=g.wrap.contents();f(q)(k.config.sc);r()}else{r()}}},_getContent:function(q){switch(q.type){case"image":var o=q.target[0].tagName,p;switch(o){case"IMG":p=q.target.attr("src");q._getImage(p);break;case"A":p=q.target.attr("href");q._getImage(p);break;default:p=q.target[0].getAttribute(q.source);q._getImage(p)}break;case"ajax":break}n.$on("content:ready",function(s,r){q.content=r;this.currWindow=q;n.param=r;n.show=true;c(function(){g.wrap.removeClass("win-close").addClass("win-show");angular.element(d[0].body).css("overflow","hidden")},100);this.updateScope()}.bind(this))},_winSize:function(){var p=a,q=p.innerWidth,o=p.innerHeight,r;r=q-2*this.outPadding;if(this.resize){if(r<this.minSizes.width){r=this.minSizes.width}else{if(r>this.maxSizes.width){r=this.maxSizes.width}}}else{r=this.maxSizes.width}return{pageWidth:q,viewHeight:o,wrap:r}},updateScope:function(){this.config.root.$$phase||this.config.root.$digest()}};var m=function(o){angular.extend(this,h,o);if(!this.target[0]){this.target=angular.element(this.target)}this.timestamp=Date.now();if(this.pushState){this.win_id=this.target[0].id}this.innerTplMark=this.innerTpl.replace(/[\/,\.]/g,"__");this.fullScreenTplMark=this.fullScreenTpl.replace(/[\/,\.]/g,"__");this._defWinScopeVariable();return this};m.prototype={_getImage:function(q){var p=new Image(),r=this,o={};p.onload=function(){angular.extend(o,{oric_height:p.height,oric_width:p.width,elem:p,src:q});o.ratio=o.oric_width/o.oric_height;var s=r._getImageSize(o);o.width=s[0];o.height=s[1];n.$emit("content:ready",o)};p.onerror=function(){throw ("Картинки с таким адресом не существует!")};p.src=q},_getImageSize:function(t){var s=n.content.width,p=n.inner.height,o=[];var q=s,r=p-(this.margin*2+this.padding*2);if(t.ratio<1){r-=this.outPadding}if(r<this.minSizes.height){r=this.minSizes.height}if((t.oric_width/q)>(t.oric_height/r)){o[0]=q;o[1]=Math.round(t.oric_height*q/t.oric_width)}else{o[0]=Math.round(t.oric_width*r/t.oric_height);o[1]=r}return o},_defWinScopeVariable:function(){var o=k._winSize.call(this);angular.extend(n,{show:false,content:{width:o.wrap,padding:this.padding},inner:{width:o.pageWidth,height:o.viewHeight,padding:this.margin+"px 0 "+this.margin+"px 0"}});g.wrap.addClass("win-effect-"+this.effect);this.scope=n},bind:function(q,p){var o=q+":"+this.timestamp;n.$on(o,p.bind(this))},trigger:function(o){arguments[0]=o+":"+this.timestamp;n.$broadcast.apply(n,arguments)}};return{create:function(o){return j(o)},getInstance:function(p,o,q){c(function(){q(p[o])},0)}}}]);