var win=angular.module("popupWindow",[]);win.factory("$tplCache",["$cacheFactory",function(a){return a("tplCache")}]);win.value("$sectors",{});win.value("$groups",{});win.directive("ngSectors",["$sectors",function(a){return function(c,d,b){a[b.ngSectors]=d}}]);win.directive("ngGroup",["$groups","$popupWindow",function(a,b){return function(e,f,c){var g=c.ngGroup,d=b.unicid();f[0].setAttribute("unicid",d);if(a[g]){a[g].push({unicid:d,target:f})}else{a[g]=[];a[g].push({unicid:d,target:f})}}}]);win.directive("ngPopupWin",["$popupWindow","$rootScope",function(b,a){return{scope:{options:"=?",win:"=?",ngClick:"="},replace:false,template:'<div id="window-wrap" ng-show="show"></div><div ng-show="show" id="wrap-inner" ng-style="{width:inner.width + \'px\', height:inner.height + \'px\', padding:inner.padding}"><div id="wrap-block" ng-sectors="wrap" ng-hide="fullscreen" ng-style="{width: content.width + \'px\', padding: content.padding + \'px\'}"></div></div><div ng-sectors="fullScreen" ng-show="fullscreen"></div>',link:function(d,e,c){if(d.options){d.options.sc=d}else{d.options={sc:d}}var f=b.create(d.options);d.close=function(){f.close()};d.prev=function(){f.prev()};d.next=function(){f.next()};d.full=function(){f.full()}}}}]);win.factory("$storage",[function(){var b=function(e){var d=JSON.stringify(e,function(f,g){switch(f){case"target":case"scope":return undefined;break;case"beforeContentLoaded":case"beforePagination":case"afterContentLoaded":case"afterClose":case"winResize":return g.toString();break}return g});localStorage.setItem(e.win_id,d)};var c=function(d){return JSON.parse(localStorage[d])};var a=function(){localStorage.clear()};return{set:b,get:c,clear:a}}]);win.factory("$fullScreen",["$document","$rootScope",function(g,a){var f=g[0];var b=function(d){if(d.requestFullscreen){d.requestFullscreen()}else{if(d.mozRequestFullScreen){d.mozRequestFullScreen()}else{if(d.webkitRequestFullscreen){d.webkitRequestFullscreen()}else{if(d.msRequestFullscreen){d.msRequestFullscreen()}}}}};var e=function(){if(f.exitFullscreen){f.exitFullscreen()}else{if(f.mozCancelFullScreen){f.mozCancelFullScreen()}else{if(f.webkitCancelFullScreen){f.webkitCancelFullScreen()}else{if(f.msExitFullscreen){f.msExitFullscreen()}}}}};var c=function(){if(f.fullscreenEnabled){f.addEventListener("fullscreenchange",function(){if(!f.fullScreen){a.$emit("window:fullScreenClose")}},false)}else{if(f.mozFullScreenEnabled){f.addEventListener("mozfullscreenchange",function(){if(!f.mozFullScreen){a.$emit("window:fullScreenClose")}},false)}else{if(f.webkitFullscreenEnabled){f.addEventListener("webkitfullscreenchange",function(){if(!f.webkitIsFullScreen){a.$emit("window:fullScreenClose")}},false)}else{if(f.msFullscreenEnabled){f.addEventListener("msfullscreenchange",function(){if(!f.msFullscreenElement){a.$emit("window:fullScreenClose")}},false)}}}}};return{openFullScreen:b,cancelFullScreen:e,fullScreeEvent:c}}]);win.factory("$popupWindow",["$rootScope","$timeout","$tplCache","$sectors","$document","$window","$http","$compile","$storage","$location","$groups","$fullScreen",function(i,q,b,l,r,m,t,o,h,g,a,d){var s,p,c,k,j={pushState:false,target:null,resize:true,margin:10,effect:1,source:null,scope:null,type:"image",href:null,imageClass:"resize",keyControll:true,win_id:null,innerTpl:"tpl/defInnerTpl.html",fullScreenTpl:"tpl/fullScreenTpl.html",outPadding:100,padding:10,resizeDelay:100,requestParam:{},ajax:{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8"}},maxSizes:{width:1024,height:768},minSizes:{width:640,height:480}};d.fullScreeEvent();var n=function(w){if(!(this instanceof n)){return new n(w)}u=this.config={locScope:null,root:i,windows:[],currWindow:null,timestamp:Date.now(),timerDelay:0};angular.extend(u,w);c=this.config.sc;this.open=function(y){var z=new f(y);this._loadTpl.call(z,"innerTpl",function(){this._getContent(z)}.bind(this))};var v=g.search();angular.element(m).on("resize",function(){if(this.currWindow){this.delay(function(){this._resizeWindow()}.bind(this))}}.bind(this));u.locScope.win=this;p=this;if(v.win_id){var u=h.get(v.win_id);if(!u.href){var x=function(){q(function(){u.target=r[0].querySelector("#"+v.win_id);if(u.target){this.open(u)}else{x.call(this)}}.bind(this),100)};x.call(this)}}c.$on("content:ready",function(A,y,z){z.content=y;this.currWindow=z;if(angular.isObject(y)){c.param={};angular.extend(c.param,z.requestParam,y)}else{c.param=z.requestParam}c.show=true;q(function(){if(c.fullscreen){l.fullScreen.removeClass("win-close").addClass("win-show")}else{l.wrap.removeClass("win-close").addClass("win-show")}angular.element(r[0].body).css("overflow","hidden");if(z.group){var B=a[z.group].length;c.count=B;c.index=z.index+1;if(B===1){c.nav={prev:false,next:false}}else{if(z.index===0){c.nav={prev:false,next:true}}else{if(z.index===B-1){c.nav={prev:true,next:false}}else{c.nav={prev:true,next:true}}}}}else{c.nav={prev:false,next:false}}this.callEvent("afterContentLoaded",z,l)}.bind(this),100);this._updateUrl(z);this.updateScope()}.bind(this));this.close=function(){c.show=false;if(v.win_id){delete v.win_id;g.search(v)}angular.element(r[0].body).css("overflow","auto");l.wrap.removeClass("win-show").addClass("win-close");this.callEvent("afterClose",this.currWindow,l)};this.full=function(){var y=this.currWindow;k=this.config.root.$on("window:fullScreenClose",function(){this.unfull(y)}.bind(this));r.on("keydown",function(z){if(z.keyCode===116){z.preventDefault()}});this._loadTpl.call(y,"fullScreenTpl",function(){var z=this._winSize.call(y);y.maxSizes={width:z.pageWidth,height:z.viewHeight};l.fullScreen.addClass("win-effect-1 win-show")}.bind(this),"fullScreen");c.fullscreen=true;d.openFullScreen(l.fullScreen[0])};this.unfull=function(y){k();r.off("keydown");l.fullScreen.removeClass("win-effect-1 win-show");y.maxSizes=y.callOptions.maxSizes;c.fullscreen=false;d.cancelFullScreen()};this.prev=function(){this.currWindow._navigate("prev")};this.next=function(){this.currWindow._navigate("next")};r.on("keydown",function(A){var z=this.currWindow;if(z){if(z.keyControll&&z.group){var y=A.keyCode;switch(y){case 39:this.currWindow._navigate("next");break;case 37:this.currWindow._navigate("prev");break}}}}.bind(this))};n.prototype={delay:function(u){q.cancel(this.timerDelay);this.timerDelay=q(function(){u()},this.currWindow.resizeDelay)},_openFull:function(){var u=this.currWindow;console.log(this._winSize())},_resizeWindow:function(){var u=this._winSize.call(this.currWindow),v=this.currWindow.content;c.inner.width=u.pageWidth;c.inner.height=u.viewHeight;if(this.currWindow.resize){c.content.width=u.wrap;if(this.currWindow.imgResize){var w=this.currWindow._getImageSize(v);c.param.width=w[0];c.param.height=w[1]}}this.callEvent("winResize",this.currWindow,l,u);this.updateScope()},_loadTpl:function(v,y,w){var z=l.wrap[0].querySelector("[mark="+this[v+"Mark"]+"]"),u=b.get(this[v+"Mark"]);if(!w){w="wrap"}if(!z&&!u){t.post(this[v]).success(function(A){l[w].html(A);var B=l[w].contents();B[0].setAttribute("mark",this[v+"Mark"]);o(B)(p.config.sc);b.put(this[v+"Mark"],A);y()}.bind(this))}else{if(!z&&u){l[w].html(u);var x=l[w].contents();o(x)(p.config.sc);y()}else{y()}}},_getContent:function(w){var u=w.target?w.target[0].tagName:"noelem",v;this.callEvent("beforeContentLoaded",w,l);switch(u){case"IMG":v=w.target.attr("src");break;case"A":v=w.target.attr("href");break;case"noelem":v=w.href;break;default:v=w.target[0].getAttribute(w.source)}v=v||w.href;if(v){switch(w.type){case"image":w._getImage(v,function(x){c.$broadcast("content:ready",x,w)});break;case"ajax":w._getAjax(v);break;case"inline":w._getInline(v);break}if(w.pushState){h.set(w)}}else{throw ("Не получилось отыскать ссылку на запрашиваемый контент!")}},_updateUrl:function(){if(this.currWindow.pushState){var u=g.search();u.win_id=this.currWindow.win_id;g.search(u)}},_winSize:function(){var v=m,x=v.innerWidth,u=v.innerHeight,y;y=x-2*this.outPadding;if(this.resize){if(y<this.minSizes.width){y=this.minSizes.width}else{if(y>this.maxSizes.width){y=this.maxSizes.width}}}else{y=this.maxSizes.width}return{pageWidth:x,viewHeight:u,wrap:y}},updateScope:function(){this.config.root.$$phase||this.config.root.$digest()},callEvent:function(){var u=arguments[0],v=this.currWindow||arguments[1];if(v[u]){if(typeof v[u]==="string"){new Function("call = "+v[u]+"; return call.apply(win, arguments);").apply(v,arguments)}else{v[u].apply(v,arguments)}}}};var f=function(u){this.callOptions=u;if(!this.callOptions.maxSizes){this.callOptions.maxSizes=j.maxSizes}angular.extend(this,j,u);if(this.target){this.target=this.target[0]?this.target:angular.element(this.target);this._getCurrUnicID()}else{this.noelem=true}this.ajax.method=this.ajax.method.toUpperCase();this.timestamp=Date.now();if(this.pushState){this.win_id=this.win_id||this.target[0].id;if(!this.win_id){this.pushState=false}}this.innerTplMark=this.innerTpl.replace(/[\/,\.]/g,"__");this.fullScreenTplMark=this.fullScreenTpl.replace(/[\/,\.]/g,"__");this._defWinScopeVariable();return this};f.prototype={_navigate:function(u){var w;switch(u){case"prev":w=this.index-1;break;case"next":w=this.index+1;break}var x=a[this.group][w];if(x){this.callOptions.target=x.target;var v={};angular.extend(v,this.callOptions);if(c.fullscreen){v.maxSizes=this.maxSizes;l.fullScreen.removeClass("win-show").addClass("win-close")}else{v.maxSizes=this.callOptions.maxSizes;l.wrap.removeClass("win-show").addClass("win-close")}p.callEvent("beforePagination",win,l,x);q(function(){p.open(v)}.bind(this),600)}else{if(u==="prev"){c.nav.prev=false}else{c.nav.next=false}}},_getCurrUnicID:function(){var u=this.unicid=this.target[0].getAttribute("unicid");if(u){this.group=this.target[0].getAttribute("ng-group");angular.forEach(a[this.group],function(x,w){if(x.unicid===u){this.index=w}}.bind(this))}},_getAjax:function(w){var x=this,v=function(z){var y="";if(angular.isObject(z)){angular.forEach(z,function(B,A){if(angular.isObject(B)){y+=v(z[A])}else{y+=A+"="+B+"&"}});return y.substr(0,y.length-1)}else{throw ("Дополнительные параметры должны передаваться в виде объекта!")}};switch(x.ajax.method.toUpperCase()){case"POST":x.ajax.data=x.requestParam;x.ajax.transformRequest=function(y){return v(y)}.bind(this);break;case"GET":x.ajax.params=x.requestParam;break;default:throw ("Ваш метод отправки не поддерживается!")}x.ajax.url=w;var u={};angular.extend(u,j.ajax,x.ajax);t(u).success(function(z){if(angular.isObject(z)){if(z.src){x._getImage(z.src,function(A){angular.extend(z,A);c.$broadcast("content:ready",z,x)})}else{c.$broadcast("content:ready",z,x)}}else{l.content.html(z);var y=l.content.contents();o(y)(c);this._checkImgInContent(z)}}.bind(this))},_getInline:function(u){var v=this;t.post(u).success(function(x){if(l.content){l.content.html(x);var w=l.content.contents();o(w)(c);this._checkImgInContent(x)}else{throw ("При типе вызова inline в подгружаемом шаблоне должна быть диектива ng-sectors='content'")}}.bind(this))},_checkImgInContent:function(w){var u=l.content[0].querySelector("img."+this.imageClass),x=this;if(u){var v=u.src;this._getImage(v,function(y){y.data=w;c.$broadcast("content:ready",y,x)})}else{c.$broadcast("content:ready",w,x)}},_getImage:function(w,y){var v=new Image(),x=this,u={};v.onload=function(){angular.extend(u,{oric_height:v.height,oric_width:v.width,elem:v,src:w});u.ratio=u.oric_width/u.oric_height;var z=x._getImageSize(u);u.width=z[0];u.height=z[1];x.imgResize=true;y(u)};v.onerror=function(){throw ("Картинки с таким адресом не существует!")};v.src=w},_getImageSize:function(z){var y=c.content.width,v=c.inner.height,u=[];var w=y,x=v-(this.margin*2+this.padding*2);if(z.ratio<1){x-=this.outPadding}if(x<this.minSizes.height){x=this.minSizes.height}if((z.oric_width/w)>(z.oric_height/x)){u[0]=w;u[1]=Math.round(z.oric_height*w/z.oric_width)}else{u[0]=Math.round(z.oric_width*x/z.oric_height);u[1]=x}return u},_defWinScopeVariable:function(){var u=p._winSize.call(this);angular.extend(c,{show:false,content:{width:u.wrap,padding:this.padding},inner:{width:u.pageWidth,height:u.viewHeight,padding:this.margin+"px 0 "+this.margin+"px 0"}});l.wrap.addClass("win-effect-"+this.effect);this.scope=c},bind:function(w,v){var u=w+":"+this.timestamp;c.$on(u,v.bind(this))},trigger:function(u){arguments[0]=u+":"+this.timestamp;c.$broadcast.apply(c,arguments)}};var e=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)};return{create:function(u){return n(u)},getInstance:function(v,u,w){q(function(){w(v[u])},0)},unicid:e}}]);